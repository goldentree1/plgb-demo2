import{c as wo,W as co,X as ro,d as H,u as P,af as ao,ag as Oo}from"./rpcWorker-X0469dqW.js";const lo=7,fo=4.5,Do=7,Ao={C:"G",G:"C",A:"T",T:"A"},Po=.6;function ho({base:o,isSimplex:K,refbase:b,snps:g,ref:_,score0:y}){var T,R,E,j;if(o==="N")return{modifiable:y,detectable:y};const k=Ao[o],L=(((T=g[o])===null||T===void 0?void 0:T.entryDepth)||0)+(b===o?_.entryDepth:0),Y=(((R=g[k])===null||R===void 0?void 0:R.entryDepth)||0)+(b===k?_.entryDepth:0),u=L+Y,z=K?(((E=g[o])===null||E===void 0?void 0:E[1])||0)+(((j=g[k])===null||j===void 0?void 0:j[-1])||0)+(b===o?_[1]:0)+(b===k?_[-1]:0):u;return{modifiable:u,detectable:z}}async function jo(o,K){var b;const{features:g,regions:_,bpPerPx:y,colorBy:T,displayCrossHatches:R,visibleModifications:E={},simplexModifications:j=[],scaleOpts:k,height:L,theme:Y,config:u,ticks:z,stopToken:U}=K,po=wo.createJBrowseTheme(Y),I=_[0],mo=(I.end-I.start)/y,N=Oo,w=L-N*2,x={...k,range:[0,w]},bo=co(x),go=co({...x,range:[0,w/2],scaleType:"linear"}),yo=ro(k.scaleType),uo=ro("linear"),vo=H.readConfObject(u,"indicatorThreshold"),So=H.readConfObject(u,"showInterbaseCounts"),To=H.readConfObject(u,"showArcs"),ko=H.readConfObject(u,"showInterbaseIndicators"),h=t=>w-(bo(t)||0)+N,O=t=>h(yo)-h(t),oo=t=>w-(go(t)||0)+N,to=t=>oo(uo)-oo(t),{bases:W,softclip:Co,hardclip:Mo,insertion:_o}=po.palette,D={A:W.A.main,C:W.C.main,G:W.G.main,T:W.T.main,insertion:_o,softclip:Co,hardclip:Mo,total:H.readConfObject(u,"color"),mod_NONE:"blue",cpg_meth:"red",cpg_unmeth:"blue"};o.fillStyle=D.total,P.forEachWithStopTokenCheck(g.values(),U,t=>{if(t.get("type")==="skip")return;const[v,d]=P.featureSpanPx(t,I,y),A=d-v+Po,r=t.get("score");o.fillRect(v,h(r),A,O(r))});let eo=0;const no=I.reversed?1/y:0,Eo=T.type==="modifications",Io=T.type==="methylation",F=(b=T.modifications)===null||b===void 0?void 0:b.isolatedModification,so=new Set(j);if(P.forEachWithStopTokenCheck(g.values(),U,t=>{var v;if(t.get("type")==="skip")return;const[d,A]=P.featureSpanPx(t,I,y),r=t.get("snpinfo"),S=Math.max(A-d,1),s=t.get("score");if(Eo){let e=0;const a=(v=r.refbase)===null||v===void 0?void 0:v.toUpperCase(),{nonmods:l,mods:c,snps:n,ref:i}=r,f=Object.keys(l).sort().reverse();for(const C of f){const $=C.replace(/^(nonmod_|mod_)/,""),p=E[$];if(!p){console.warn(`${C} not known yet`);continue}if(F&&p.type!==F)continue;const{modifiable:J,detectable:V}=ho({base:p.base,isSimplex:so.has(p.type),refbase:a,snps:n,ref:i,score0:s}),{entryDepth:X,avgProbability:q=0}=r.nonmods[C],M=J/s*(X/V),Q=ao("blue",q),m=O(s),Z=h(s)+m;o.fillStyle=Q,o.fillRect(Math.round(d),Z-(e+M*m),S,M*m),e+=M*m}const B=Object.keys(c).sort().reverse();for(const C of B){const $=C.replace("mod_",""),p=E[$];if(!p){console.warn(`${C} not known yet`);continue}if(F&&p.type!==F)continue;const{modifiable:J,detectable:V}=ho({base:p.base,isSimplex:so.has(p.type),refbase:a,snps:n,ref:i,score0:s}),{entryDepth:X,avgProbability:q=0}=c[C],M=J/s*(X/V),io=p.color||"black",Q=ao(io,q),m=O(s),Z=h(s)+m;o.fillStyle=Q,o.fillRect(Math.round(d),Z-(e+M*m),S,M*m),e+=M*m}}else if(Io){const{depth:e,nonmods:a,mods:l}=r;let c=0;for(const n of Object.keys(l).sort().reverse()){const{entryDepth:i}=l[n],f=O(s),B=h(s)+f;o.fillStyle=D[n]||"black",o.fillRect(Math.round(d),B-(i+c)/e*f,S,i/e*f),c+=i}for(const n of Object.keys(a).sort().reverse()){const{entryDepth:i}=a[n],f=O(s),B=h(s)+f;o.fillStyle=D[n]||"black",o.fillRect(Math.round(d),B-(i+c)/e*f,S,i/e*f),c+=i}}else{const{depth:e,snps:a}=r;let l=0;for(const c of Object.keys(a).sort().reverse()){const{entryDepth:n}=a[c],i=O(s),f=h(s)+i;o.fillStyle=D[c]||"black",o.fillRect(Math.round(d),f-(n+l)/e*i,S,n/e*i),l+=n}}const G=Object.keys(r.noncov);if(So){let e=0;for(const a of G){const{entryDepth:l}=r.noncov[a],c=.6;o.fillStyle=D[a],o.fillRect(d-c+no,fo+to(e),c*2,to(l)),e+=l}}if(ko){let e=0,a=0,l="";for(const n of G){const{entryDepth:i}=r.noncov[n];e+=i,i>a&&(a=i,l=n)}const c=Math.max(s,eo);if(e>c*vo&&c>Do){o.fillStyle=D[l],o.beginPath();const n=d+no;o.moveTo(n-lo/2,0),o.lineTo(n+lo/2,0),o.lineTo(n,fo),o.fill()}}eo=s}),To&&P.forEachWithStopTokenCheck(g.values(),U,t=>{if(t.get("type")!=="skip")return;const v=t.get("start"),d=t.get("end"),[A,r]=P.bpSpanPx(v,d,I,y);o.beginPath();const S=t.get("effectiveStrand"),s="rgba(255,200,200,0.7)",G="rgba(200,200,255,0.7)",e="rgba(200,200,200,0.7)";S===1?o.strokeStyle=s:S===-1?o.strokeStyle=G:o.strokeStyle=e,o.lineWidth=Math.log(t.get("score")+1),o.moveTo(A,w-N*2),o.bezierCurveTo(A,0,r,0,r,w-N*2),o.stroke()}),R){o.lineWidth=1,o.strokeStyle="rgba(140,140,140,0.8)";for(const t of z.values)o.beginPath(),o.moveTo(0,Math.round(h(t))),o.lineTo(mo,Math.round(h(t))),o.stroke()}}export{jo as makeImage};
//# sourceMappingURL=makeImage-Ci0NpDDK.js.map
