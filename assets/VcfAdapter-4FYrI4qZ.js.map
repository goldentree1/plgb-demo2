{"version":3,"file":"VcfAdapter-4FYrI4qZ.js","sources":["../node_modules/@jbrowse/plugin-variants/esm/VcfAdapter/vcfParser.js","../node_modules/@jbrowse/plugin-variants/esm/VcfAdapter/VcfAdapter.js"],"sourcesContent":["import { parseLineByLine } from '@jbrowse/core/util/parseLineByLine';\nexport function parseVcfBuffer(buffer, statusCallback = () => { }) {\n    const headerLines = [];\n    const featureMap = {};\n    parseLineByLine(buffer, line => {\n        if (line.startsWith('#')) {\n            headerLines.push(line);\n        }\n        else {\n            const ret = line.indexOf('\\t');\n            const refName = line.slice(0, ret);\n            if (!featureMap[refName]) {\n                featureMap[refName] = [];\n            }\n            featureMap[refName].push(line);\n        }\n        return true;\n    }, statusCallback);\n    return {\n        header: headerLines.join('\\n'),\n        featureMap,\n    };\n}\n","import { IntervalTree } from '@flatten-js/interval-tree';\nimport VcfParser from '@gmod/vcf';\nimport { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { fetchAndMaybeUnzip } from '@jbrowse/core/util';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport VcfFeature from '../VcfFeature';\nimport { parseVcfBuffer } from './vcfParser';\nclass VcfAdapter extends BaseFeatureDataAdapter {\n    constructor() {\n        super(...arguments);\n        this.calculatedIntervalTreeMap = {};\n    }\n    async getHeader() {\n        const { header } = await this.setup();\n        return header;\n    }\n    async getMetadata() {\n        const { parser } = await this.setup();\n        return parser.getMetadata();\n    }\n    async setupP(opts) {\n        const { statusCallback = () => { } } = opts || {};\n        const loc = openLocation(this.getConf('vcfLocation'), this.pluginManager);\n        const buffer = await fetchAndMaybeUnzip(loc, opts);\n        const { header, featureMap } = parseVcfBuffer(buffer, statusCallback);\n        const parser = new VcfParser({ header });\n        const intervalTreeMap = Object.fromEntries(Object.entries(featureMap).map(([refName, lines]) => [\n            refName,\n            (sc) => {\n                if (!this.calculatedIntervalTreeMap[refName]) {\n                    sc === null || sc === void 0 ? void 0 : sc('Parsing VCF data');\n                    let idx = 0;\n                    const intervalTree = new IntervalTree();\n                    for (const line of lines) {\n                        const f = new VcfFeature({\n                            variant: parser.parseLine(line),\n                            parser,\n                            id: `${this.id}-${refName}-${idx++}`,\n                        });\n                        intervalTree.insert([f.get('start'), f.get('end')], f);\n                    }\n                    this.calculatedIntervalTreeMap[refName] = intervalTree;\n                }\n                return this.calculatedIntervalTreeMap[refName];\n            },\n        ]));\n        return {\n            header,\n            parser,\n            intervalTreeMap,\n        };\n    }\n    async setup() {\n        if (!this.vcfFeatures) {\n            this.vcfFeatures = this.setupP().catch((e) => {\n                this.vcfFeatures = undefined;\n                throw e;\n            });\n        }\n        return this.vcfFeatures;\n    }\n    async getRefNames(_ = {}) {\n        const { intervalTreeMap } = await this.setup();\n        return Object.keys(intervalTreeMap);\n    }\n    getFeatures(region, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            var _a;\n            try {\n                const { start, end, refName } = region;\n                const { intervalTreeMap } = await this.setup();\n                for (const f of ((_a = intervalTreeMap[refName]) === null || _a === void 0 ? void 0 : _a.call(intervalTreeMap, opts.statusCallback).search([\n                    start,\n                    end,\n                ])) || []) {\n                    observer.next(f);\n                }\n                observer.complete();\n            }\n            catch (e) {\n                observer.error(e);\n            }\n        }, opts.stopToken);\n    }\n    async getSources() {\n        const conf = this.getConf('samplesTsvLocation');\n        if (conf.uri === '' || conf.uri === '/path/to/samples.tsv') {\n            const { parser } = await this.setup();\n            return parser.samples.map(name => ({\n                name,\n            }));\n        }\n        else {\n            const txt = await openLocation(conf).readFile('utf8');\n            const lines = txt.split(/\\n|\\r\\n|\\r/);\n            const header = lines[0].split('\\t');\n            const { parser } = await this.setup();\n            const s = new Set(parser.samples);\n            return lines\n                .slice(1)\n                .map(line => {\n                const cols = line.split('\\t');\n                return {\n                    name: cols[0],\n                    ...Object.fromEntries(cols.slice(1).map((c, idx) => [header[idx + 1], c])),\n                };\n            })\n                .filter(f => s.has(f.name));\n        }\n    }\n}\nVcfAdapter.capabilities = ['getFeatures', 'getRefNames'];\nexport default VcfAdapter;\n"],"names":["parseVcfBuffer","buffer","statusCallback","headerLines","featureMap","parseLineByLine","line","ret","refName","VcfAdapter","BaseFeatureDataAdapter","header","parser","opts","loc","openLocation","fetchAndMaybeUnzip","VcfParser","intervalTreeMap","lines","sc","idx","intervalTree","IntervalTree","f","VcfFeature","e","_","region","ObservableCreate","observer","_a","start","end","conf","name","s","cols","c"],"mappings":"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","x_google_ignoreList":[0,1]}