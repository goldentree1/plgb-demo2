import{o as D,a as o,u as x,j as e,D as O,B as u,T,d as W,R as B,c as A,e as I,t as z,l as _,aW as F,aX as q,m as J}from"./index-DUxFddIG.js";import{R as G}from"./RadioGroup-DhU66J4p.js";import{F as H}from"./FormControlLabel-ClCs1Dm_.js";import{R as N}from"./Radio-BLHiKPmH.js";const U=D(function({model:t,children:c,handleClose:a}){const[g,v]=o.useState(""),[m,d]=o.useState(),[b,C]=o.useState(!1),[f,P]=o.useState(""),[y,w]=o.useState(!1),[E,M]=x.useLocalStorage("cluster-samplesPerPixel","1");return e.jsxs(e.Fragment,{children:[e.jsxs(O,{children:[c,e.jsxs("div",{style:{marginTop:50},children:[e.jsx(u,{variant:"contained",onClick:()=>{w(!y)},children:y?"Hide advanced options":"Show advanced options"}),y?e.jsxs("div",{style:{marginTop:20},children:[e.jsx(T,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),e.jsx(W,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:E,onChange:j=>{M(j.target.value)}})]}):null]}),e.jsxs("div",{children:[b?e.jsxs("div",{style:{padding:50},children:[e.jsx("span",{children:g||"Loading..."}),e.jsx(u,{onClick:()=>{B.stopStopToken(f)},children:"Stop"})]}):null,m?e.jsx(A.ErrorMessage,{error:m}):null]})]}),e.jsxs(I,{children:[e.jsx(u,{variant:"contained",disabled:b,onClick:async()=>{var j;try{d(void 0),v("Initializing"),C(!0);const l=x.getContainingView(t);if(!l.initialized)return;const{rpcManager:R}=x.getSession(t),{sourcesWithoutLayout:h,adapterConfig:L}=t;if(h){const s=z.getRpcSessionId(t),i=B.createStopToken();P(i);const p=await R.call(s,"MultiWiggleClusterScoreMatrix",{regions:l.dynamicBlocks.contentBlocks,sources:h,sessionId:s,adapterConfig:L,stopToken:i,bpPerPx:l.bpPerPx/+E,statusCallback:r=>{v(r)}}),k=!((j=t.layout)===null||j===void 0)&&j.length?t.layout:h,n=Object.fromEntries(k.map(r=>[r.name,r]));t.setLayout(p.order.map(r=>{const S=h[r];if(!S)throw new Error(`out of bounds at ${r}`);return{...S,...n[S.name]}}))}a()}catch(l){!x.isAbortException(l)&&_(t)&&(console.error(l),d(l))}finally{C(!1),v(""),P("")}},children:"Run clustering"}),e.jsx(u,{variant:"contained",color:"secondary",onClick:()=>{a(),f&&B.stopStopToken(f)},children:"Cancel"})]})]})}),X=J()(t=>({textAreaFont:{fontFamily:"Courier New"},mgap:{display:"flex",flexDirection:"column",gap:t.spacing(4)}})),K=D(function({model:t,handleClose:c,children:a}){const{classes:g}=X(),[v,m]=o.useState(""),[d,b]=o.useState(),[C,f]=o.useState(),[P,y]=o.useState(!1),[w,E]=x.useLocalStorage("cluster-showAdvanced",!1),[M,j]=o.useState("single"),[l,R]=o.useState("1");o.useEffect(()=>{(async()=>{try{f(void 0),b(void 0),y(!0);const s=x.getContainingView(t),{dynamicBlocks:i,bpPerPx:p}=s,{rpcManager:k}=x.getSession(t),{sourcesWithoutLayout:n,adapterConfig:r}=t,S=z.getRpcSessionId(t),V=await k.call(S,"MultiWiggleGetScoreMatrix",{regions:i.contentBlocks,sources:n,sessionId:S,adapterConfig:r,bpPerPx:p/+l});b(V)}catch(s){!x.isAbortException(s)&&_(t)&&(console.error(s),f(s))}finally{y(!1)}})()},[t,l]);const h=d?String.raw`inputMatrix<-matrix(c(${Object.values(d).map(s=>s.join(",")).join(`,
`)}
),nrow=${Object.values(d).length},byrow=TRUE)
rownames(inputMatrix)<-c(${Object.keys(d).map(s=>`'${s}'`).join(",")})
resultClusters<-hclust(dist(inputMatrix), method='${M}')
cat(resultClusters$order,sep='\n')`:void 0,L=d?Object.entries(d).map(([s,i])=>[s,...i].join("	")).join(`
`):void 0;return e.jsxs(e.Fragment,{children:[e.jsxs(O,{children:[a,e.jsxs("div",{style:{marginTop:50},children:[e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"16px"},children:[e.jsx(u,{variant:"contained",onClick:()=>{F.saveAs(new Blob([h||""],{type:"text/plain;charset=utf-8"}),"cluster.R")},children:"Download Rscript"})," ","or"," ",e.jsx(u,{variant:"contained",onClick:()=>{q(h||"")},children:"Copy Rscript to clipboard"})," ","or"," ",e.jsx(u,{variant:"contained",onClick:()=>{F.saveAs(new Blob([L||""],{type:"text/plain;charset=utf-8"}),"scores.tsv")},children:"Download TSV"})]}),e.jsx("div",{children:e.jsx(u,{variant:"contained",onClick:()=>{E(!w)},children:w?"Hide advanced options":"Show advanced options"})}),w?e.jsxs("div",{children:[e.jsx(T,{variant:"h6",children:"Advanced options"}),e.jsx(G,{children:Object.entries({single:"Single",complete:"Complete"}).map(([s,i])=>e.jsx(H,{control:e.jsx(N,{checked:M===s,onChange:()=>{j(s)}}),label:i},s))}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(T,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),e.jsx(W,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:l,onChange:s=>{R(s.target.value)}})]})]}):null,h?e.jsx("div",{}):P?e.jsx(A.LoadingEllipses,{variant:"h6",message:"Generating score matrix"}):C?e.jsx(A.ErrorMessage,{error:C}):null]}),e.jsxs("div",{children:[e.jsx(T,{variant:"subtitle2",gutterBottom:!0,style:{marginTop:"16px"},children:"Clustering Results:"}),e.jsx(W,{multiline:!0,fullWidth:!0,variant:"outlined",placeholder:"Paste results from Rscript here (sequence of numbers, one per line, specifying the new ordering)",rows:10,value:v,onChange:s=>{m(s.target.value)},slotProps:{input:{classes:{input:g.textAreaFont}}}})]})]})]}),e.jsxs(I,{children:[e.jsx(u,{variant:"contained",onClick:()=>{var s;const{sourcesWithoutLayout:i}=t;if(i)try{const p=!((s=t.layout)===null||s===void 0)&&s.length?t.layout:i,k=Object.fromEntries(p.map(n=>[n.name,n]));t.setLayout(v.split(`
`).map(n=>n.trim()).filter(n=>!!n).map(n=>+n).map(n=>{const r=i[n-1];if(!r)throw new Error(`out of bounds at ${n}`);return{...r,...k[r.name]}}))}catch(p){console.error(p),x.getSession(t).notifyError(`${p}`,p)}c()},children:"Apply clustering"}),e.jsx(u,{variant:"contained",color:"secondary",onClick:()=>{c()},children:"Cancel"})]})]})});function $({activeMode:t,setActiveMode:c}){return e.jsx("div",{children:e.jsx(G,{children:Object.entries({auto:e.jsx("div",{children:"Run in-app clustering (slower, particularly for large numbers of samples, uses JS implementation of hclust)"}),manual:e.jsx("div",{children:"Download R script to run clustering (faster, uses R implementation of hclust)"})}).map(([a,g])=>e.jsx(H,{control:e.jsx(N,{checked:t===a,onChange:()=>{c(a)}}),label:g},a))})})}const te=D(function({model:t,handleClose:c}){const[a,g]=o.useState("auto");return e.jsx(A.Dialog,{open:!0,title:"Cluster by score",maxWidth:"xl",onClose:(v,m)=>{m!=="backdropClick"&&c()},children:a==="auto"?e.jsx(U,{model:t,handleClose:c,children:e.jsx($,{activeMode:a,setActiveMode:g})}):e.jsx(K,{model:t,handleClose:c,children:e.jsx($,{activeMode:a,setActiveMode:g})})})});export{te as default};
//# sourceMappingURL=WiggleClusterDialog-DkHt5HIc.js.map
