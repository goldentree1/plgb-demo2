import{s as F,K as W,bu as X,u as k,ai as z,bt as tt,am as U,az as et,c as ot,ac as nt}from"./index-DUxFddIG.js";import{f as G}from"./color-CtySM7W0.js";import{a as st,b as it,c as rt,d as lt,g as ct}from"./getMaximumModificationAtEachPosition-maSfsFLt.js";function at(t){return t.get("is_paired")&&t.get("refName")!==t.get("next_ref")?"#555":`hsl(${Math.abs(t.get("template_length"))/10},50%,50%)`}function ft(t){return`hsl(${t.get("score")},50%,50%)`}function dt(t,d){const l=F.readConfObject(d,"orientationType"),P=W[l][t.get("pair_orientation")];return{LR:"color_pair_lr",RR:"color_pair_rr",RL:"color_pair_rl",LL:"color_pair_ll"}[P]}function pt(t){return t.get("strand")===-1?"#8F8FD8":"#EC8B8B"}function ht(t,d){return G[dt(t,d)||"color_nostrand"]}function ut(t){const d=t.get("flags"),l=t.get("strand");if(d&1){const h=d&64?-1:1;return d&2?l*h===1?"color_rev_strand":"color_fwd_strand":d&8?l*h===1?"color_rev_missing_mate":"color_fwd_missing_mate":t.get("refName")===t.get("next_ref")?l*h===1?"color_rev_strand_not_proper":"color_fwd_strand_not_proper":l===1?"color_fwd_diff_chr":"color_rev_diff_chr"}return"color_unknown"}function gt(t){return G[ut(t)]}function mt({colorType:t,tag:d,feature:l,config:h,defaultColor:P,colorTagMap:r}){switch(t){case"insertSize":return at(l);case"strand":return pt(l);case"mappingQuality":return ft(l);case"pairOrientation":return ht(l,h);case"stranded":return gt(l);case"xs":case"tag":{const n=l.get("tags"),g=n?n[d]:l.get(d);return d==="XS"||d==="TS"?g==="-"?G.color_rev_strand:g==="+"?G.color_fwd_strand:G.color_nostrand:d==="ts"?g==="-"?l.get("strand")===-1?G.color_fwd_strand:G.color_rev_strand:g==="+"?l.get("strand")===-1?G.color_rev_strand:G.color_fwd_strand:G.color_nostrand:r[g]||G.color_nostrand}case"insertSizeAndPairOrientation":break;case"modifications":case"methylation":return l.get("flags")&16?"#c8dcc8":"#c8c8c8";default:return P?"lightgrey":F.readConfObject(h,"color",{feature:l})}}function bt({ctx:t,feat:d,renderArgs:l}){const{regions:h,bpPerPx:P}=l,{heightPx:r,topPx:n,feature:g}=d,u=h[0],T=g.get("start"),R=g.get("end"),b=g.get("CIGAR"),x=u.reversed?-1:1,w=g.get("strand")*x,S=P<10&&r>5;if(b!=null&&b.includes("N")){const p=X(b);if(w===1){let c=0,s=T;for(let f=0;f<p.length;f+=2){const o=+p[f],e=p[f+1];if(e==="M"||e==="X"||e==="="||e==="D")c+=o;else if(e==="N"){if(s!==c){const[i,m]=k.bpSpanPx(s,s+c,u,P),q=m-i;t.fillRect(i,n,q,r)}s+=c+o,c=0}}if(s!==c){const[f,o]=k.bpSpanPx(s,s+c,u,P),e=o-f;S?(t.beginPath(),t.moveTo(f,n),t.lineTo(f,n+r),t.lineTo(o,n+r),t.lineTo(o+5,n+r/2),t.lineTo(o,n),t.closePath(),t.fill()):t.fillRect(f,n,e,r)}}else if(w===-1){let c=0,s=R;for(let f=p.length-2;f>=0;f-=2){const o=+p[f],e=p[f+1];if(e==="M"||e==="X"||e==="="||e==="D")c+=o;else if(e==="N"){if(c!==0){const[i,m]=k.bpSpanPx(s-c,s,u,P);t.fillRect(i,n,m-i,r)}s-=c+o,c=0}}if(c!==0){const[f,o]=k.bpSpanPx(s-c,s,u,P),e=o-f;S?(t.beginPath(),t.moveTo(f-5,n+r/2),t.lineTo(f,n+r),t.lineTo(o,n+r),t.lineTo(o,n),t.lineTo(f,n),t.closePath(),t.fill()):t.fillRect(f,n,e,r)}}}else{const[p,c]=k.bpSpanPx(T,R,u,P);P<10&&r>5?w===-1?(t.beginPath(),t.moveTo(p-5,n+r/2),t.lineTo(p,n+r),t.lineTo(c,n+r),t.lineTo(c,n),t.lineTo(p,n),t.closePath(),t.fill()):(t.beginPath(),t.moveTo(p,n),t.lineTo(p,n+r),t.lineTo(c,n+r),t.lineTo(c+5,n+r/2),t.lineTo(c,n),t.closePath(),t.fill()):t.fillRect(p,n,c-p,r)}}function O(t,d,l,h,P,r,n){d+h<0||d>r||(n&&(t.fillStyle=n),t.fillRect(d,l,h,P))}function V(t){const{skip:d,deletion:l,insertion:h,hardclip:P,softclip:r,bases:n}=t.palette;return{A:n.A.main,C:n.C.main,G:n.G.main,T:n.T.main,deletion:l,insertion:h,hardclip:P,softclip:r,skip:d}}function Pt(t){return Object.fromEntries(Object.entries(V(t)).map(([d,l])=>[d,t.palette.getContrastText(l)]))}function _t(t){return["methylation","modifications"].includes(t||"")}function yt(){return!0}function Y(){const t=k.measureText("A"),d=k.measureText("M")-2;return{charWidth:t,charHeight:d}}function St({ctx:t,feat:d,region:l,bpPerPx:h,renderArgs:P,canvasWidth:r,cigarOps:n}){const{regionSequence:g}=P,{feature:u,topPx:T,heightPx:R}=d;if(!g)throw new Error("region sequence required for methylation");if(!u.get("seq"))return;const x=u.get("start"),w=u.get("end"),{methBins:S,methProbs:p,hydroxyMethBins:c,hydroxyMethProbs:s}=st(u,n);function f(e){if(S[e]){const i=p[e]||0;return(i>.5?z.colord("red").alpha((i-.5)*2):z.colord("blue").alpha(1-i*2)).toHslString()}if(c[e]){const i=s[e]||0;return(i>.5?z.colord("pink").alpha((i-.5)*2):z.colord("purple").alpha(1-i*2)).toHslString()}}const o=g.toLowerCase();for(let e=0;e<w-x;e++){const i=e+x,m=o[i-l.start+1],q=o[i-l.start+2];if(m==="c"&&q==="g")if(h>2){const[_,B]=k.bpSpanPx(i,i+2,l,h),v=B-_+.5,C=f(e)||f(e+1)||"blue";O(t,_,T,v,R,r,C)}else{const[_,B]=k.bpSpanPx(i,i+1,l,h),v=B-_+.5,C=f(e)||"blue";O(t,_,T,v,R,r,C);const[a,$]=k.bpSpanPx(i+1,i+2,l,h),D=$-a+.5,j=f(e+1)||"blue";O(t,a,T,D,R,r,j)}}}function Tt({ctx:t,feat:d,region:l,bpPerPx:h,renderArgs:P,canvasWidth:r,cigarOps:n}){var g,u,T,R,b;const x=[],w=[],{feature:S,topPx:p,heightPx:c}=d,{colorBy:s,visibleModifications:f={}}=P,o=S.get("seq");if(!o)return{coords:w,items:x};const e=S.get("start"),i=(g=s==null?void 0:s.modifications)===null||g===void 0?void 0:g.isolatedModification,m=(u=s==null?void 0:s.modifications)===null||u===void 0?void 0:u.twoColor,_=((R=(T=s==null?void 0:s.modifications)===null||T===void 0?void 0:T.threshold)!==null&&R!==void 0?R:10)/100,B=S.get("strand"),v=tt(S,"MM","Mm")||"",C=it(v,o,B),a=rt(S),$=new Map;let D=0;for(const{type:j,base:y,strand:N,positions:A}of C){for(const{ref:M,idx:L}of lt(n,A)){const I=(a==null?void 0:a[D+(B===-1?A.length-1-L:L)])||0;$.has(M)||$.set(M,[]),$.get(M).push({type:j,base:y,strand:N,prob:I})}D+=A.length}return(b=ct(S,n))===null||b===void 0||b.forEach(({allProbs:j,prob:y,type:N},A)=>{const M=e+A,[L,I]=k.bpSpanPx(M,M+1,l,h),E=f[N];if(!E){console.warn(`${N} not known yet`);return}if(i&&E.type!==i||y<_)return;const J=E.color||"black",K=1-k.sum(j);if(m&&K>k.max(j)){const H=U("blue",K),Q=I-L+.5;O(t,L,p,Q,c,r,H)}else{const H=U(J,y),Q=I-L+.5;O(t,L,p,Q,c,r,H)}const Z=($.get(A)||[]).map(H=>`${H.base}${H.strand}${H.type} ${et(H.type)} (${(H.prob*100).toFixed(1)}%)`).join("<br/>");x.push({type:"modification",seq:Z||E.base,modType:N,probability:y}),w.push(L,p,I,p+c),A++}),{coords:w,items:x}}function wt({ctx:t,feat:d,region:l,bpPerPx:h,colorMap:P,colorContrastMap:r,charWidth:n,charHeight:g,canvasWidth:u,cigarOps:T}){const R=g-2,{feature:b,topPx:x,heightPx:w}=d,S=b.get("seq"),p=1/h,c=b.get("start");let s=0,f=0;if(S)for(let o=0;o<T.length;o+=2){const e=+T[o],i=T[o+1];if(i==="S"||i==="I")s+=e;else if(i==="D"||i==="N")f+=e;else if(i==="M"||i==="X"||i==="="){for(let m=0;m<e;m++){const q=S[s+m],_=c+f+m,[B]=k.bpSpanPx(_,_+1,l,h),v=P[q];O(t,B,x,p+.5,w,u,v),p>=n&&w>=R&&(t.fillStyle=r[q],t.fillText(q,B+(p-n)/2+1,x+w))}s+=e,f+=e}}}function Ct({ctx:t,feat:d,region:l,bpPerPx:h,canvasWidth:P,cigarOps:r}){const{feature:n,topPx:g,heightPx:u}=d,R=(n.get("qual")||"").split(" ").map(p=>+p),b=1/h,x=n.get("start");let w=0,S=0;for(let p=0;p<r.length;p+=2){const c=+r[p],s=r[p+1];if(s==="S"||s==="I")w+=c;else if(s==="D"||s==="N")S+=c;else if(s==="M"||s==="X"||s==="="){for(let f=0;f<c;f++){const o=R[w+f],e=x+S+f,i=k.bpSpanPx(e,e+1,l,h)[0],m=`hsl(${o===255?150:o*1.5},55%,50%)`;O(t,i,g,b+.5,u,P,m)}w+=c,S+=c}}}function Mt({ctx:t,feat:d,renderArgs:l,colorMap:h,colorContrastMap:P,charWidth:r,charHeight:n,defaultColor:g,canvasWidth:u}){const T=[],R=[],{config:b,bpPerPx:x,regions:w,colorBy:S,colorTagMap:p={}}=l,{tag:c="",type:s=""}=S||{},{feature:f}=d,o=w[0];switch(t.fillStyle=mt({feature:f,config:b,tag:c,defaultColor:g,colorType:s,colorTagMap:p}),bt({ctx:t,feat:d,renderArgs:l}),s){case"perBaseQuality":{const e=X(f.get("CIGAR"));Ct({ctx:t,feat:d,region:o,bpPerPx:x,canvasWidth:u,cigarOps:e});break}case"perBaseLettering":{const e=X(f.get("CIGAR"));wt({ctx:t,feat:d,region:o,bpPerPx:x,colorMap:h,colorContrastMap:P,charWidth:r,charHeight:n,canvasWidth:u,cigarOps:e});break}case"modifications":{const e=X(f.get("CIGAR")),i=Tt({ctx:t,feat:d,region:o,bpPerPx:x,renderArgs:l,canvasWidth:u,cigarOps:e});for(let m=0,q=i.coords.length;m<q;m++)R.push(i.coords[m]);for(let m=0,q=i.items.length;m<q;m++)T.push(i.items[m]);break}case"methylation":{const e=X(f.get("CIGAR"));St({ctx:t,feat:d,region:o,bpPerPx:x,renderArgs:l,canvasWidth:u,cigarOps:e});break}}return{coords:R,items:T}}function qt({ctx:t,feat:d,renderArgs:l,minSubfeatureWidth:h,largeInsertionIndicatorScale:P,mismatchAlpha:r,charWidth:n,charHeight:g,colorMap:u,colorContrastMap:T,hideSmallIndels:R,canvasWidth:b,drawSNPsMuted:x,drawIndels:w=!0}){var S;const p=[],c=[],{bpPerPx:s,regions:f}=l,{heightPx:o,topPx:e,feature:i}=d,m=f[0],q=i.get("start"),_=Math.min(1/s,2),B=(S=i.get("mismatches"))!==null&&S!==void 0?S:[],v=g-2,C=m.reversed?1/s+1:-1;for(const a of B){const $=q+a.start,D=a.length,j=a.base,[y,N]=k.bpSpanPx($,$+D,m,s),A=Math.max(h,N-y);if(a.type==="mismatch"){if(p.push({type:"mismatch",seq:a.base}),c.push(y,e,N,e+o),!x){const M=u[a.base]||"#888",L=r&&a.qual!==void 0?z.colord(M).alpha(Math.min(1,a.qual/50)).toHslString():M;O(t,Math.round(y),e,A,o,b,L)}if(A>=n&&o>=v){const M=x?"black":T[a.base]||"black";t.fillStyle=r&&a.qual!==void 0?z.colord(M).alpha(Math.min(1,a.qual/50)).toHslString():M,t.fillText(j,y+(A-n)/2+1,e+o)}}else if(a.type==="deletion"&&w){const M=a.length;if(!R||M>=10){O(t,y,e,Math.abs(y-N),o,b,u.deletion),p.push({type:"deletion",seq:`${a.length}`}),c.push(y,e,N,e+o);const L=`${a.length}`,I=k.measureText(L,10);A>=I&&o>=v&&(t.fillStyle=T.deletion,t.fillText(L,(y+N)/2-I/2,e+o))}}else if(a.type==="insertion"&&w){const M=y+C,L=+a.base||a.length,I=Math.max(0,Math.min(1.2,1/s));if(L<10&&!R&&(O(t,M,e,I,o,b,u.insertion),1/s>=n&&o>=v)){p.push({type:"insertion",seq:a.insertedBases||"unknown"}),c.push(y-2,e,y+I+2,e+o);const E=Math.round(M-I);O(t,E,e,I*3,1,b),O(t,E,e+o-1,I*3,1,b),t.fillText(`(${a.base})`,M+3,e+o)}}else if(a.type==="hardclip"||a.type==="softclip"){const M=y+C,L=u[a.type],I=Math.max(h,_);if(O(t,M,e,I,o,b,L),1/s>=n&&o>=v){const E=M-I;O(t,E,e,I*3,1,b),O(t,E,e+o-1,I*3,1,b),t.fillText(`(${a.base})`,M+3,e+o)}}else if(a.type==="skip"&&y+A>0){const M=A-(s>10?1.5:0),L=Math.max(0,y),I=e+o/2-1,E=M+Math.min(y,0);O(t,L,I,E,1,b,u.skip)}}if(w)for(const a of B){const $=q+a.start,D=a.length,j=+a.base||a.length;if(a.type==="insertion"&&j>=10){const[y]=k.bpSpanPx($,$+D,m,s),N=`${j}`;if(p.push({type:"insertion",seq:a.insertedBases||"unknown"}),c.push(y-3,e,y+4,e+o),s>P)O(t,y-1,e,2,o,b,u.insertion);else if(o>g){const A=k.measureText(N),M=5;O(t,y-A/2-M,e,A+2*M,o,b,"purple"),t.fillStyle=T.insertion,t.fillText(N,y-A/2,e+o)}else O(t,y-2,e,4,o,b,u.insertion)}}return{coords:c,items:p}}function Bt({ctx:t,feat:d,renderArgs:l,config:h,theme:P,colorMap:r,canvasWidth:n}){const{feature:g,topPx:u,heightPx:T}=d,{regions:R,bpPerPx:b}=l,x=R[0],w=F.readConfObject(h,"minSubfeatureWidth"),S=g.get("mismatches"),p=g.get("seq"),{charWidth:c,charHeight:s}=Y();if(!(p&&S))return;const f=s-2;let o=0,e=0;const i=g.get("CIGAR"),m=X(i);for(let q=0;q<m.length;q+=2){const _=m[q+1],B=+m[q];if(_==="S"){for(let v=0;v<B;v++){const C=p[o+v],a=g.get("start")-(q===0?B:0)+e+v,[$,D]=k.bpSpanPx(a,a+1,x,b),j=Math.max(w,D-$),y=r[C]||"#000000";t.fillStyle=y,O(t,$,u,j,T,n),j>=c&&T>=f&&(t.fillStyle=P.palette.getContrastText(y),t.fillText(C,$+(j-c)/2+1,u+T))}o+=B}_==="N"&&(e+=B),(_==="M"||_==="="||_==="X")&&(e+=B,o+=B),_==="D"&&(e+=B),_==="I"&&(o+=B)}}function kt({ctx:t,layoutRecords:d,canvasWidth:l,renderArgs:h}){const{stopToken:P,config:r,showSoftClip:n,colorBy:g,theme:u}=h,T=F.readConfObject(r,"mismatchAlpha"),R=F.readConfObject(r,"minSubfeatureWidth"),b=F.readConfObject(r,"largeInsertionIndicatorScale"),x=F.readConfObject(r,"hideSmallIndels"),w=F.readConfObject(r,"color")==="#f0f",S=ot.createJBrowseTheme(u),p=V(S),c=Pt(S);t.font="bold 10px Courier New,monospace";const{charWidth:s,charHeight:f}=Y(),o=_t(g==null?void 0:g.type),e=yt(),i=[],m=[];k.forEachWithStopTokenCheck(d,P,_=>{const B=Mt({ctx:t,feat:_,renderArgs:h,defaultColor:w,colorMap:p,colorContrastMap:c,charWidth:s,charHeight:f,canvasWidth:l});for(let C=0,a=B.coords.length;C<a;C++)i.push(B.coords[C]);for(let C=0,a=B.items.length;C<a;C++)m.push(B.items[C]);const v=qt({ctx:t,feat:_,renderArgs:h,hideSmallIndels:x,mismatchAlpha:T,drawSNPsMuted:o,drawIndels:e,largeInsertionIndicatorScale:b,minSubfeatureWidth:R,charWidth:s,charHeight:f,colorMap:p,colorContrastMap:c,canvasWidth:l});for(let C=0,a=v.coords.length;C<a;C++)i.push(v.coords[C]);for(let C=0,a=v.items.length;C<a;C++)m.push(v.items[C]);n&&Bt({ctx:t,feat:_,renderArgs:h,colorMap:p,config:r,theme:S,canvasWidth:l})});const q=new nt(Math.max(m.length,1));if(i.length)for(let _=0;_<i.length;_+=4)q.add(i[_],i[_+1],i[_+2],i[_+3]);else q.add(0,0);return q.finish(),{flatbush:q.data,items:m}}export{kt as makeImageData};
//# sourceMappingURL=makeImageData-BAL29eGo.js.map
