{"version":3,"file":"TrixTextSearchAdapter-CgY3s9MW.js","sources":["../node_modules/@gmod/trix/esm/dedupe.js","../node_modules/@gmod/trix/esm/util.js","../node_modules/@gmod/trix/esm/index.js","../node_modules/@jbrowse/plugin-trix/esm/TrixTextSearchAdapter/TrixTextSearchAdapter.js"],"sourcesContent":["// from https://github.com/seriousManual/dedupe/blob/master/LICENSE\nexport function dedupe(list, hasher = JSON.stringify) {\n    const clone = [];\n    const lookup = new Set();\n    for (const entry of list) {\n        const hashed = hasher(entry);\n        if (!lookup.has(hashed)) {\n            clone.push(entry);\n            lookup.add(hashed);\n        }\n    }\n    return clone;\n}\n//# sourceMappingURL=dedupe.js.map","export function sum(array) {\n    let total = 0;\n    for (const entry of array) {\n        total += entry.length;\n    }\n    return total;\n}\nexport function concatUint8Array(args) {\n    const mergedArray = new Uint8Array(sum(args));\n    let offset = 0;\n    for (const entry of args) {\n        mergedArray.set(entry, offset);\n        offset += entry.length;\n    }\n    return mergedArray;\n}\n//# sourceMappingURL=util.js.map","import { dedupe } from \"./dedupe.js\";\nimport { concatUint8Array } from \"./util.js\";\nconst CHUNK_SIZE = 65536;\n// this is the number of hex characters to use for the address in ixixx, see\n// https://github.com/GMOD/ixixx-js/blob/master/src/index.ts#L182\nconst ADDRESS_SIZE = 10;\nexport default class Trix {\n    ixxFile;\n    ixFile;\n    maxResults;\n    decoder = new TextDecoder('utf8');\n    indexCache;\n    ixFileSize;\n    constructor(ixxFile, ixFile, maxResults = 20) {\n        this.ixxFile = ixxFile;\n        this.ixFile = ixFile;\n        this.maxResults = maxResults;\n    }\n    async getIxFileSize(opts) {\n        if (this.ixFileSize !== undefined) {\n            return this.ixFileSize;\n        }\n        try {\n            // @ts-expect-error\n            const stat = await this.ixFile.stat(opts);\n            this.ixFileSize = stat.size;\n            return this.ixFileSize;\n        }\n        catch {\n            return undefined;\n        }\n    }\n    async search(searchString, opts) {\n        let resultArr = [];\n        const searchWords = searchString.split(' ');\n        const firstWord = searchWords[0];\n        // validate that we have a non-empty search term\n        if (firstWord) {\n            const searchWord = firstWord.toLowerCase();\n            const res = await this.getBuffer(searchWord, opts);\n            let { end, buffer } = res;\n            const { fileSize } = res;\n            let done = false;\n            // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n            while (!done) {\n                const str = this.decoder.decode(buffer);\n                // slice to lastIndexOf('\\n') to make sure we get complete records\n                // since the buffer fetch could get halfway into a record\n                const lines = str\n                    .slice(0, str.lastIndexOf('\\n'))\n                    .split('\\n')\n                    .filter(Boolean);\n                const hits2 = [];\n                for (const line of lines) {\n                    const word = line.split(' ')[0];\n                    if (word.startsWith(searchWord)) {\n                        hits2.push(line);\n                    }\n                    else if (word > searchWord) {\n                        // we are done scanning if we are lexicographically greater than\n                        // the search string\n                        done = true;\n                    }\n                }\n                const hits = hits2.flatMap(line => {\n                    const [term, ...parts] = line.split(' ');\n                    return parts\n                        .filter(Boolean)\n                        .map(elt => [term, elt.split(',')[0]]);\n                });\n                resultArr = resultArr.concat(hits);\n                // if we are done or have filled up maxResults, break\n                if (done || resultArr.length >= this.maxResults) {\n                    break;\n                }\n                // avoid reading past end of file\n                if (fileSize !== undefined && end >= fileSize) {\n                    break;\n                }\n                // fetch more data, clamping to file size if known\n                let bytesToRead = CHUNK_SIZE;\n                if (fileSize !== undefined) {\n                    bytesToRead = Math.min(CHUNK_SIZE, fileSize - end);\n                }\n                const res2 = await this.ixFile.read(bytesToRead, end, opts);\n                if (res2.length === 0) {\n                    break;\n                }\n                buffer = concatUint8Array([buffer, res2]);\n                end += res2.length;\n            }\n        }\n        // de-duplicate results based on the detail column (resultArr[1])\n        return dedupe(resultArr, elt => elt[1]).slice(0, this.maxResults);\n    }\n    async getIndex(opts) {\n        if (this.indexCache) {\n            return this.indexCache;\n        }\n        const file = await this.ixxFile.readFile({\n            encoding: 'utf8',\n            ...opts,\n        });\n        const result = file\n            .split('\\n')\n            .filter(Boolean)\n            .map(line => {\n            const p = line.length - ADDRESS_SIZE;\n            const prefix = line.slice(0, p);\n            const posStr = line.slice(p);\n            const pos = Number.parseInt(posStr, 16);\n            return [prefix, pos];\n        });\n        this.indexCache = result;\n        return result;\n    }\n    async getBuffer(searchWord, opts) {\n        let start = 0;\n        let end = CHUNK_SIZE;\n        const indexes = await this.getIndex(opts);\n        for (const [key, value] of indexes) {\n            const trimmedKey = key.slice(0, searchWord.length);\n            if (trimmedKey < searchWord) {\n                start = value;\n                end = value + CHUNK_SIZE;\n            }\n        }\n        const fileSize = await this.getIxFileSize(opts);\n        if (fileSize !== undefined) {\n            end = Math.min(end, fileSize);\n        }\n        const buffer = await this.ixFile.read(end - start, start, opts);\n        return { buffer, end, fileSize };\n    }\n}\n//# sourceMappingURL=index.js.map","import Trix from '@gmod/trix';\nimport BaseResult from '@jbrowse/core/TextSearch/BaseResults';\nimport { readConfObject } from '@jbrowse/core/configuration';\nimport { BaseAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { openLocation } from '@jbrowse/core/util/io';\nfunction decodeURIComponentNoThrow(uri) {\n    try {\n        return decodeURIComponent(uri);\n    }\n    catch (e) {\n        return uri;\n    }\n}\nfunction shorten(str, term, w = 15) {\n    const tidx = str.toLowerCase().indexOf(term);\n    return str.length < 40\n        ? str\n        : (Math.max(0, tidx - w) > 0 ? '...' : '') +\n            str.slice(Math.max(0, tidx - w), tidx + term.length + w).trim() +\n            (tidx + term.length < str.length ? '...' : '');\n}\nexport default class TrixTextSearchAdapter extends BaseAdapter {\n    constructor(config, getSubAdapter, pluginManager) {\n        super(config, getSubAdapter, pluginManager);\n        const ixFilePath = readConfObject(config, 'ixFilePath');\n        const ixxFilePath = readConfObject(config, 'ixxFilePath');\n        if (!ixFilePath) {\n            throw new Error('must provide out.ix');\n        }\n        if (!ixxFilePath) {\n            throw new Error('must provide out.ixx');\n        }\n        this.trixJs = new Trix(openLocation(ixxFilePath, pluginManager), openLocation(ixFilePath, pluginManager), 1500);\n    }\n    async searchIndex(args) {\n        const query = args.queryString.toLowerCase();\n        const strs = query.split(' ');\n        const results = await this.trixJs.search(query);\n        const formatted = results\n            .filter(([, data]) => strs.every(r => decodeURIComponentNoThrow(data).toLowerCase().includes(r)))\n            .map(([term, data]) => {\n            const result = JSON.parse(data.replaceAll('|', ','));\n            const [loc, trackId, ...rest] = result.map(record => decodeURIComponentNoThrow(record));\n            const labelFieldIdx = rest.findIndex(elt => !!elt);\n            const contextIdx = rest\n                .map(elt => elt.toLowerCase())\n                .findIndex(f => f.includes(term.toLowerCase()));\n            const labelField = rest[labelFieldIdx];\n            const contextField = rest[contextIdx];\n            const context = contextIdx !== -1 ? shorten(contextField, term) : undefined;\n            const label = shorten(labelField, term);\n            const displayString = !context || label.toLowerCase() === context.toLowerCase()\n                ? label\n                : `${label} (${context})`;\n            return new BaseResult({\n                locString: loc,\n                label: labelField,\n                displayString,\n                matchedObject: result.map(record => decodeURIComponent(record)),\n                trackId,\n            });\n        });\n        return args.searchType === 'exact'\n            ? formatted.filter(r => r.getLabel().toLowerCase() === args.queryString.toLowerCase())\n            : formatted;\n    }\n}\n"],"names":["dedupe","list","hasher","clone","lookup","entry","hashed","sum","array","total","concatUint8Array","args","mergedArray","offset","CHUNK_SIZE","ADDRESS_SIZE","Trix","ixxFile","ixFile","maxResults","__publicField","opts","stat","searchString","resultArr","firstWord","searchWord","res","end","buffer","fileSize","done","str","lines","hits2","line","word","hits","term","parts","elt","bytesToRead","res2","result","p","prefix","posStr","pos","start","indexes","key","value","decodeURIComponentNoThrow","uri","shorten","w","tidx","TrixTextSearchAdapter","BaseAdapter","config","getSubAdapter","pluginManager","ixFilePath","readConfObject","ixxFilePath","openLocation","query","strs","formatted","data","r","loc","trackId","rest","record","labelFieldIdx","contextIdx","f","labelField","contextField","context","label","displayString","BaseResult"],"mappings":"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","x_google_ignoreList":[0,1,2,3]}