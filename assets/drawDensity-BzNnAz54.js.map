{"version":3,"file":"drawDensity-BzNnAz54.js","sources":["../../node_modules/@jbrowse/plugin-wiggle/esm/drawDensity.js"],"sourcesContent":["import { readConfObject } from '@jbrowse/core/configuration';\nimport { featureSpanPx } from '@jbrowse/core/util';\nimport { checkStopToken } from '@jbrowse/core/util/stopToken';\nimport { fillRectCtx, getScale } from './util';\nconst fudgeFactor = 0.3;\nconst clipHeight = 2;\nexport function drawDensity(ctx, props) {\n    const { stopToken, features, regions, bpPerPx, scaleOpts, height, config } = props;\n    const region = regions[0];\n    const pivot = readConfObject(config, 'bicolorPivot');\n    const pivotValue = readConfObject(config, 'bicolorPivotValue');\n    const negColor = readConfObject(config, 'negColor');\n    const posColor = readConfObject(config, 'posColor');\n    const color = readConfObject(config, 'color');\n    const clipColor = readConfObject(config, 'clipColor');\n    const crossing = pivot !== 'none' && scaleOpts.scaleType !== 'log';\n    const scale = getScale({\n        ...scaleOpts,\n        pivotValue: crossing ? pivotValue : undefined,\n        range: crossing ? [negColor, '#eee', posColor] : ['#eee', posColor],\n    });\n    const scale2 = getScale({ ...scaleOpts, range: [0, height] });\n    const cb = color === '#f0f'\n        ? (_, score) => scale(score)\n        : (feature, score) => readConfObject(config, 'color', { feature, score });\n    const domain = scale2.domain();\n    const niceMin = domain[0];\n    const niceMax = domain[1];\n    let prevLeftPx = Number.NEGATIVE_INFINITY;\n    let hasClipping = false;\n    const reducedFeatures = [];\n    let start = performance.now();\n    for (const feature of features.values()) {\n        if (performance.now() - start > 400) {\n            checkStopToken(stopToken);\n            start = performance.now();\n        }\n        const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx);\n        if (Math.floor(leftPx) !== Math.floor(prevLeftPx) || rightPx - leftPx > 1) {\n            reducedFeatures.push(feature);\n            prevLeftPx = leftPx;\n        }\n        const score = feature.get('score');\n        hasClipping = hasClipping || score > niceMax || score < niceMin;\n        const w = rightPx - leftPx + fudgeFactor;\n        if (score >= scaleOpts.domain[0]) {\n            ctx.fillStyle = cb(feature, score);\n            ctx.fillRect(leftPx, 0, w, height);\n        }\n        else {\n            ctx.fillStyle = '#eee';\n            ctx.fillRect(leftPx, 0, w, height);\n        }\n    }\n    ctx.save();\n    if (hasClipping) {\n        ctx.fillStyle = clipColor;\n        for (const feature of features.values()) {\n            if (performance.now() - start > 400) {\n                checkStopToken(stopToken);\n                start = performance.now();\n            }\n            const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx);\n            const w = rightPx - leftPx + fudgeFactor;\n            const score = feature.get('score');\n            if (score > niceMax) {\n                fillRectCtx(leftPx, 0, w, clipHeight, ctx);\n            }\n            else if (score < niceMin && scaleOpts.scaleType !== 'log') {\n                fillRectCtx(leftPx, 0, w, clipHeight, ctx);\n            }\n        }\n    }\n    ctx.restore();\n    return {\n        reducedFeatures,\n    };\n}\n"],"names":["fudgeFactor","clipHeight","drawDensity","ctx","props","stopToken","features","regions","bpPerPx","scaleOpts","height","config","region","pivot","readConfObject","pivotValue","negColor","posColor","color","clipColor","crossing","scale","getScale","scale2","cb","_","score","feature","domain","niceMin","niceMax","prevLeftPx","hasClipping","reducedFeatures","start","checkStopToken","leftPx","rightPx","featureSpanPx","w","fillRectCtx"],"mappings":"iEAIA,MAAMA,EAAc,GACdC,EAAa,EACZ,SAASC,EAAYC,EAAKC,EAAO,CACpC,KAAM,CAAE,UAAAC,EAAW,SAAAC,EAAU,QAAAC,EAAS,QAAAC,EAAS,UAAAC,EAAW,OAAAC,EAAQ,OAAAC,CAAM,EAAKP,EACvEQ,EAASL,EAAQ,CAAC,EAClBM,EAAQC,EAAAA,eAAeH,EAAQ,cAAc,EAC7CI,EAAaD,EAAAA,eAAeH,EAAQ,mBAAmB,EACvDK,EAAWF,EAAAA,eAAeH,EAAQ,UAAU,EAC5CM,EAAWH,EAAAA,eAAeH,EAAQ,UAAU,EAC5CO,EAAQJ,EAAAA,eAAeH,EAAQ,OAAO,EACtCQ,EAAYL,EAAAA,eAAeH,EAAQ,WAAW,EAC9CS,EAAWP,IAAU,QAAUJ,EAAU,YAAc,MACvDY,EAAQC,EAAS,CACnB,GAAGb,EACH,WAAYW,EAAWL,EAAa,OACpC,MAAOK,EAAW,CAACJ,EAAU,OAAQC,CAAQ,EAAI,CAAC,OAAQA,CAAQ,CAC1E,CAAK,EACKM,EAASD,EAAS,CAAE,GAAGb,EAAW,MAAO,CAAC,EAAGC,CAAM,EAAG,EACtDc,EAAKN,IAAU,OACf,CAACO,EAAGC,IAAUL,EAAMK,CAAK,EACzB,CAACC,EAASD,IAAUZ,iBAAeH,EAAQ,QAAS,CAAE,QAAAgB,EAAS,MAAAD,EAAO,EACtEE,EAASL,EAAO,OAAM,EACtBM,EAAUD,EAAO,CAAC,EAClBE,EAAUF,EAAO,CAAC,EACxB,IAAIG,EAAa,OAAO,kBACpBC,EAAc,GAClB,MAAMC,EAAkB,CAAA,EACxB,IAAIC,EAAQ,YAAY,IAAG,EAC3B,UAAWP,KAAWrB,EAAS,SAAU,CACjC,YAAY,MAAQ4B,EAAQ,MAC5BC,EAAAA,eAAe9B,CAAS,EACxB6B,EAAQ,YAAY,IAAG,GAE3B,KAAM,CAACE,EAAQC,CAAO,EAAIC,EAAAA,cAAcX,EAASf,EAAQJ,CAAO,GAC5D,KAAK,MAAM4B,CAAM,IAAM,KAAK,MAAML,CAAU,GAAKM,EAAUD,EAAS,KACpEH,EAAgB,KAAKN,CAAO,EAC5BI,EAAaK,GAEjB,MAAMV,EAAQC,EAAQ,IAAI,OAAO,EACjCK,EAAcA,GAAeN,EAAQI,GAAWJ,EAAQG,EACxD,MAAMU,EAAIF,EAAUD,EAASpC,EACzB0B,GAASjB,EAAU,OAAO,CAAC,GAC3BN,EAAI,UAAYqB,EAAGG,EAASD,CAAK,EACjCvB,EAAI,SAASiC,EAAQ,EAAGG,EAAG7B,CAAM,IAGjCP,EAAI,UAAY,OAChBA,EAAI,SAASiC,EAAQ,EAAGG,EAAG7B,CAAM,EAEzC,CAEA,GADAP,EAAI,KAAI,EACJ6B,EAAa,CACb7B,EAAI,UAAYgB,EAChB,UAAWQ,KAAWrB,EAAS,SAAU,CACjC,YAAY,MAAQ4B,EAAQ,MAC5BC,EAAAA,eAAe9B,CAAS,EACxB6B,EAAQ,YAAY,IAAG,GAE3B,KAAM,CAACE,EAAQC,CAAO,EAAIC,EAAAA,cAAcX,EAASf,EAAQJ,CAAO,EAC1D+B,EAAIF,EAAUD,EAASpC,EACvB0B,EAAQC,EAAQ,IAAI,OAAO,EAC7BD,EAAQI,EACRU,EAAYJ,EAAQ,EAAGG,EAAGtC,EAAYE,CAAG,EAEpCuB,EAAQG,GAAWpB,EAAU,YAAc,OAChD+B,EAAYJ,EAAQ,EAAGG,EAAGtC,EAAYE,CAAG,CAEjD,CACJ,CACA,OAAAA,EAAI,QAAO,EACJ,CACH,gBAAA8B,CACR,CACA","x_google_ignoreList":[0]}