var A=Object.defineProperty;var B=(n,e,t)=>e in n?A(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var x=(n,e,t)=>B(n,typeof e!="symbol"?e+"":e,t);import{s as b,a4 as g,be as E}from"./index-DUxFddIG.js";import{B as O}from"./index-D8SKdkWL.js";function T(n,e=JSON.stringify){const t=[],s=new Set;for(const o of n){const r=e(o);s.has(r)||(t.push(o),s.add(r))}return t}function k(n){let e=0;for(const t of n)e+=t.length;return e}function U(n){const e=new Uint8Array(k(n));let t=0;for(const s of n)e.set(s,t),t+=s.length;return e}const S=65536,N=10;class v{constructor(e,t,s=20){x(this,"ixxFile");x(this,"ixFile");x(this,"maxResults");x(this,"decoder",new TextDecoder("utf8"));x(this,"indexCache");x(this,"ixFileSize");this.ixxFile=e,this.ixFile=t,this.maxResults=s}async getIxFileSize(e){if(this.ixFileSize!==void 0)return this.ixFileSize;try{const t=await this.ixFile.stat(e);return this.ixFileSize=t.size,this.ixFileSize}catch{return}}async search(e,t){let s=[];const r=e.split(" ")[0];if(r){const i=r.toLowerCase(),l=await this.getBuffer(i,t);let{end:c,buffer:d}=l;const{fileSize:h}=l;let f=!1;for(;!f;){const y=this.decoder.decode(d),F=y.slice(0,y.lastIndexOf(`
`)).split(`
`).filter(Boolean),w=[];for(const m of F){const a=m.split(" ")[0];a.startsWith(i)?w.push(m):a>i&&(f=!0)}const C=w.flatMap(m=>{const[a,...z]=m.split(" ");return z.filter(Boolean).map(R=>[a,R.split(",")[0]])});if(s=s.concat(C),f||s.length>=this.maxResults||h!==void 0&&c>=h)break;let p=S;h!==void 0&&(p=Math.min(S,h-c));const u=await this.ixFile.read(p,c,t);if(u.length===0)break;d=U([d,u]),c+=u.length}}return T(s,i=>i[1]).slice(0,this.maxResults)}async getIndex(e){if(this.indexCache)return this.indexCache;const s=(await this.ixxFile.readFile({encoding:"utf8",...e})).split(`
`).filter(Boolean).map(o=>{const r=o.length-N,i=o.slice(0,r),l=o.slice(r),c=Number.parseInt(l,16);return[i,c]});return this.indexCache=s,s}async getBuffer(e,t){let s=0,o=S;const r=await this.getIndex(t);for(const[c,d]of r)c.slice(0,e.length)<e&&(s=d,o=d+S);const i=await this.getIxFileSize(t);return i!==void 0&&(o=Math.min(o,i)),{buffer:await this.ixFile.read(o-s,s,t),end:o,fileSize:i}}}function I(n){try{return decodeURIComponent(n)}catch{return n}}function L(n,e,t=15){const s=n.toLowerCase().indexOf(e);return n.length<40?n:(Math.max(0,s-t)>0?"...":"")+n.slice(Math.max(0,s-t),s+e.length+t).trim()+(s+e.length<n.length?"...":"")}class j extends O.BaseAdapter{constructor(e,t,s){super(e,t,s);const o=b.readConfObject(e,"ixFilePath"),r=b.readConfObject(e,"ixxFilePath");if(!o)throw new Error("must provide out.ix");if(!r)throw new Error("must provide out.ixx");this.trixJs=new v(g.openLocation(r,s),g.openLocation(o,s),1500)}async searchIndex(e){const t=e.queryString.toLowerCase(),s=t.split(" "),r=(await this.trixJs.search(t)).filter(([,i])=>s.every(l=>I(i).toLowerCase().includes(l))).map(([i,l])=>{const c=JSON.parse(l.replaceAll("|",",")),[d,h,...f]=c.map(a=>I(a)),y=f.findIndex(a=>!!a),F=f.map(a=>a.toLowerCase()).findIndex(a=>a.includes(i.toLowerCase())),w=f[y],C=f[F],p=F!==-1?L(C,i):void 0,u=L(w,i),m=!p||u.toLowerCase()===p.toLowerCase()?u:`${u} (${p})`;return new E({locString:d,label:w,displayString:m,matchedObject:c.map(a=>decodeURIComponent(a)),trackId:h})});return e.searchType==="exact"?r.filter(i=>i.getLabel().toLowerCase()===e.queryString.toLowerCase()):r}}export{j as default};
//# sourceMappingURL=TrixTextSearchAdapter-DLDAFI_S.js.map
