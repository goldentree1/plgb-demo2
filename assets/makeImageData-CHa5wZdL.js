import{s as q,u as w,aj as U,F as V}from"./rpcWorker-X0469dqW.js";import{d as X,f as y,g as Y,a as Z}from"./drawPhased-C_dsxJab.js";async function et(f,F){const{scrollTop:G,minorAlleleFrequencyFilter:K,sources:M,rowHeight:p,features:O,regions:W,bpPerPx:z,renderingMode:B,stopToken:u,lengthCutoffFilter:J,referenceDrawingMode:T}=F,N=W[0],{statusCallback:S=()=>{}}=F;q.checkStopToken(u);const E=await w.updateStatus("Calculating stats",S,()=>U({stopToken:u,features:O.values(),minorAlleleFrequencyFilter:K,lengthCutoffFilter:J}));q.checkStopToken(u);const n=[],h=[],j={};await w.updateStatus("Drawing variants",S,()=>{w.forEachWithStopTokenCheck(E,u,({mostFrequentAlt:t,feature:o})=>{const[x,Q]=w.featureSpanPx(o,N,z),A=o.id(),P=o.get("end")-o.get("start"),d=Math.max(Math.round(Q-x),2),D=o.get("genotypes");let e=-G;const v=M.length;if(B==="phased")for(let a=0;a<v;a++){const{name:g,HP:c}=M[a],s=D[g],l=Math.floor(x),i=Math.max(p,1);if(s)if(s.includes("|")){const k=s.split("|");X(k,f,l,e,d,i,c,void 0,T==="draw")&&(h.push({name:g,genotype:s,featureId:A,bpLen:P}),n.push(l,e,l+d,e+i))}else f.fillStyle="black",f.fillRect(l-y,e-y,d+y,i+y);e+=p}else for(let a=0;a<v;a++){const{name:g}=M[a],c=D[g],s=Math.floor(x),l=Math.max(p,1);if(c){const i=`${c}:${t}`;let r=j[i];if(r===void 0){let k=0,H=0,I=0,L=0;const R=c.split(/[/|]/),$=R.length;for(let C=0;C<$;C++){const b=R[C];b===t?k++:b==="0"?L++:b==="."?H++:I++}r=Y(L,k,I,H,$,T==="draw"),j[i]=r}r&&(Z(r,f,s,e,d,l,o.get("type"),o.get("strand"),P>5?.75:1),h.push({name:g,genotype:c,featureId:A,bpLen:P}),n.push(s,e,s+d,e+l))}e+=p}})});const m=new V(Math.max(h.length,1));if(h.length)for(let t=0;t<n.length;t+=4)m.add(n[t],n[t+1],n[t+2],n[t+3]);else m.add(0,0);return m.finish(),{flatbush:m.data,items:h,featureGenotypeMap:Object.fromEntries(E.map(({feature:t})=>[t.id(),{alt:t.get("ALT"),ref:t.get("REF"),name:t.get("name"),description:t.get("description"),length:t.get("end")-t.get("start")}]))}}export{et as makeImageData};
//# sourceMappingURL=makeImageData-CHa5wZdL.js.map
