import{o as R,a as o,j as e,D,B as u,R as A,c as k,e as L,u as p,t as $,l as O,P as z,aW as T,aX as H,T as E,d as _,m as J}from"./index-DUxFddIG.js";import{R as P}from"./RadioGroup-DhU66J4p.js";import{F as W}from"./FormControlLabel-ClCs1Dm_.js";import{R as G}from"./Radio-BLHiKPmH.js";const N=R(function({model:s,children:i,handleClose:r}){const[d,x]=o.useState(""),[g,a]=o.useState(!1),[f,j]=o.useState(),[h,C]=o.useState("");return e.jsxs(e.Fragment,{children:[e.jsxs(D,{children:[i,e.jsxs("div",{children:[g?e.jsxs("div",{style:{padding:50},children:[e.jsx("span",{children:d||"Loading..."}),e.jsx(u,{onClick:()=>{A.stopStopToken(h)},children:"Stop"})]}):null,f?e.jsx(k.ErrorMessage,{error:f}):null]})]}),e.jsxs(L,{children:[e.jsx(u,{variant:"contained",disabled:g,onClick:async()=>{try{j(void 0),x("Initializing"),a(!0);const c=p.getContainingView(s);if(!c.initialized)return;const{rpcManager:v}=p.getSession(s),{sourcesWithoutLayout:m,minorAlleleFrequencyFilter:S,lengthCutoffFilter:M,adapterConfig:y}=s;if(m){const w=$.getRpcSessionId(s),t=A.createStopToken();C(t);const n=await v.call(w,"MultiVariantClusterGenotypeMatrix",{regions:c.dynamicBlocks.contentBlocks,sources:m,minorAlleleFrequencyFilter:S,lengthCutoffFilter:M,sessionId:w,adapterConfig:y,stopToken:t,statusCallback:l=>{x(l)}});s.setLayout(n.order.map(l=>{const b=m[l];if(!b)throw new Error(`out of bounds at ${l}`);return b}))}r()}catch(c){!p.isAbortException(c)&&O(s)&&(console.error(c),j(c))}finally{a(!1),x(""),C("")}},children:"Run clustering"}),e.jsx(u,{variant:"contained",color:"secondary",onClick:()=>{r(),h&&A.stopStopToken(h)},children:"Cancel"})]})]})}),U=J()(s=>({textAreaFont:{fontFamily:"Courier New"},mgap:{display:"flex",flexDirection:"column",gap:s.spacing(4)}})),X=R(function({model:s,handleClose:i,children:r}){const{classes:d}=U(),[x,g]=o.useState(""),[a,f]=o.useState(),[j,h]=o.useState(),[C,c]=o.useState(!1),[v,m]=p.useLocalStorage("cluster-showAdvanced",!1),[S,M]=o.useState("single");o.useEffect(()=>{(async()=>{try{h(void 0),f(void 0),c(!0);const t=p.getContainingView(s);if(!t.initialized)return;const{rpcManager:n}=p.getSession(s),{sourcesWithoutLayout:l,minorAlleleFrequencyFilter:b,lengthCutoffFilter:I,adapterConfig:V}=s,F=$.getRpcSessionId(s),q=await n.call(F,"MultiVariantGetGenotypeMatrix",{regions:t.dynamicBlocks.contentBlocks,sources:l,minorAlleleFrequencyFilter:b,lengthCutoffFilter:I,sessionId:F,adapterConfig:V});f(q)}catch(t){!p.isAbortException(t)&&O(s)&&(console.error(t),h(t))}finally{c(!1)}})()},[s]);const y=a?String.raw`inputMatrix<-matrix(c(${Object.values(a).map(t=>t.join(",")).join(`,
`)}
),nrow=${Object.values(a).length},byrow=TRUE)
rownames(inputMatrix)<-c(${Object.keys(a).map(t=>`'${t}'`).join(",")})
resultClusters<-hclust(dist(inputMatrix), method='${S}')
cat(resultClusters$order,sep='\n')`:void 0,w=a?Object.entries(a).map(([t,n])=>[t,...n].join("	")).join(`
`):void 0;return e.jsxs(e.Fragment,{children:[e.jsxs(D,{children:[r,e.jsxs(z,{style:{padding:16},children:[e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"16px"},children:[e.jsx(u,{variant:"contained",onClick:()=>{T.saveAs(new Blob([y||""],{type:"text/plain;charset=utf-8"}),"cluster.R")},children:"Download Rscript"})," ","or"," ",e.jsx(u,{variant:"contained",onClick:()=>{H(y||"")},children:"Copy Rscript to clipboard"})," ","or"," ",e.jsx(u,{variant:"contained",onClick:()=>{T.saveAs(new Blob([w||""],{type:"text/plain;charset=utf-8"}),"genotypes.tsv")},children:"Download TSV"}),e.jsx("div",{children:e.jsx(u,{variant:"contained",onClick:()=>{m(!v)},children:v?"Hide advanced options":"Show advanced options"})})]}),v?e.jsxs("div",{children:[e.jsx(E,{variant:"h6",children:"Advanced options"}),e.jsx(P,{children:Object.entries({single:"Single",complete:"Complete"}).map(([t,n])=>e.jsx(W,{control:e.jsx(G,{checked:S===t,onChange:()=>{M(t)}}),label:n},t))})]}):null,y?e.jsx("div",{}):C?e.jsx(k.LoadingEllipses,{variant:"h6",message:"Generating genotype matrix"}):j?e.jsx(k.ErrorMessage,{error:j}):null]}),e.jsxs("div",{children:[e.jsx(E,{variant:"subtitle2",gutterBottom:!0,style:{marginTop:"16px"},children:"Clustering Results:"}),e.jsx(_,{multiline:!0,fullWidth:!0,variant:"outlined",placeholder:"Paste results from Rscript here (sequence of numbers, one per line, specifying the new ordering)",rows:10,value:x,onChange:t=>{g(t.target.value)},slotProps:{input:{classes:{input:d.textAreaFont}}}})]})]})]}),e.jsxs(L,{children:[e.jsx(u,{variant:"contained",onClick:()=>{const{sourcesWithoutLayout:t}=s;if(t)try{s.setLayout(x.split(`
`).map(n=>n.trim()).filter(n=>!!n).map(n=>+n).map(n=>{const l=t[n-1];if(!l)throw new Error(`out of bounds at ${n}`);return l}))}catch(n){console.error(n),p.getSession(s).notifyError(`${n}`,n)}i()},children:"Apply clustering"}),e.jsx(u,{variant:"contained",color:"secondary",onClick:()=>{i()},children:"Cancel"})]})]})});function B({activeMode:s,setActiveMode:i}){return e.jsxs("div",{children:[e.jsx(E,{style:{marginBottom:30},children:"This procedure will cluster the visible genotype data using hierarchical clustering"}),e.jsx(P,{children:Object.entries({auto:e.jsx("div",{children:"Run in-app clustering (slower, particularly for large numbers of samples, uses JS implementation of hclust)"}),manual:e.jsx("div",{children:"Download R script to run clustering (faster, uses R implementation of hclust)"})}).map(([r,d])=>e.jsx(W,{control:e.jsx(G,{checked:s===r,onChange:()=>{i(r)}}),label:d},r))})]})}const ee=R(function({model:s,handleClose:i}){const[r,d]=o.useState("auto");return e.jsx(k.Dialog,{open:!0,title:"Cluster by genotype",onClose:(x,g)=>{g!=="backdropClick"&&i()},children:r==="auto"?e.jsx(N,{model:s,handleClose:i,children:e.jsx(B,{activeMode:r,setActiveMode:d})}):e.jsx(X,{model:s,handleClose:i,children:e.jsx(B,{activeMode:r,setActiveMode:d})})})});export{ee as default};
//# sourceMappingURL=ClusterDialog-DsaT2KRW.js.map
