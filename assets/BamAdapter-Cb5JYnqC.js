import{Q as V}from"./index-Cq2N9pGB.js";import{I as Y,Z as W}from"./inflate-XVoSut8N.js";import{c as it}from"./crc32-BNi2TJ31.js";import{L as q}from"./browser-DdKr-yeI.js";import{R as B}from"./remoteFile-B4_2tkev.js";import{B as rt}from"./index-DYe7vadA.js";import{c0 as ot,c1 as Z,i as O,u as D,f as at,t as ct,s as j,c2 as ht,c3 as ut}from"./rpcWorker-X0469dqW.js";import{Q as ft}from"./QuickLRU-DUYJ4zPh.js";import{r as lt}from"./rxjs-DQbUCOsY.js";class ${constructor(t,e,n,s){this.minv=t,this.maxv=e,this.bin=n,this._fetchedSize=s}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(t){return this.minv.compareTo(t.minv)||this.maxv.compareTo(t.maxv)||this.bin-t.bin}fetchedSize(){return this._fetchedSize!==void 0?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}class J{constructor({filehandle:t,renameRefSeq:e=n=>n}){this.filehandle=t,this.renameRefSeq=e}}const H=65536,dt=H*H;function gt(o,t=0){const e=o[t]|o[t+1]<<8|o[t+2]<<16|o[t+3]<<24;return((o[t+4]|o[t+5]<<8|o[t+6]<<16|o[t+7]<<24)>>>0)*dt+(e>>>0)}function mt(o){return new Promise(t=>setTimeout(t,o))}function pt(o){if(o&&o.aborted)if(typeof DOMException>"u"){const t=new Error("aborted");throw t.code="ERR_ABORTED",t}else throw new DOMException("aborted","AbortError")}function wt(o,t){return t.minv.blockPosition-o.maxv.blockPosition<65e3&&t.maxv.blockPosition-o.minv.blockPosition<5e6}function bt(o={}){return"aborted"in o?{signal:o}:o}function K(o,t){const e=[];let n;if(o.length===0)return o;o.sort((s,i)=>{const r=s.minv.blockPosition-i.minv.blockPosition;return r===0?s.minv.dataPosition-i.minv.dataPosition:r});for(const s of o)(!t||s.maxv.compareTo(t)>0)&&(n===void 0?(e.push(s),n=s):wt(n,s)?s.maxv.compareTo(n.maxv)>0&&(n.maxv=s.maxv):(e.push(s),n=s));return e}function X(o,t){return{lineCount:gt(o,t)}}function T(o,t){return o?o.compareTo(t)>0?t:o:t}function xt(o,t=e=>e){let e=0,n=0;const s=[],i={};for(let r=0;r<o.length;r+=1)if(!o[r]){if(n<r){let c="";for(let a=n;a<r;a++)c+=String.fromCharCode(o[a]);c=t(c),s[e]=c,i[c]=e}n=r+1,e+=1}return{refNameToId:i,refIdToName:s}}function _t(o){let t=0;for(const e of o)t+=e.length;return t}function Qt(o){const t=new Uint8Array(_t(o));let e=0;for(const n of o)t.set(n,e),e+=n.length;return t}async function yt(o){let t=[];for await(const e of o)t=t.concat(e);return t}class tt{constructor(t,e){this.blockPosition=t,this.dataPosition=e}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(t){return this.blockPosition-t.blockPosition||this.dataPosition-t.dataPosition}}function S(o,t=0,e=!1){if(e)throw new Error("big-endian virtual file offsets not implemented");return new tt(o[t+7]*1099511627776+o[t+6]*4294967296+o[t+5]*16777216+o[t+4]*65536+o[t+3]*256+o[t+2],o[t+1]<<8|o[t])}const It=21578050;function At(o,t){return o-o%t}function Pt(o,t){return o-o%t+t}function Ct(o,t){return t-=1,[[0,0],[1+(o>>26),1+(t>>26)],[9+(o>>23),9+(t>>23)],[73+(o>>20),73+(t>>20)],[585+(o>>17),585+(t>>17)],[4681+(o>>14),4681+(t>>14)]]}class F extends J{async lineCount(t,e){var s,i;return((i=(s=(await this.parse(e)).indices(t))==null?void 0:s.stats)==null?void 0:i.lineCount)||0}async _parse(t){const e=await this.filehandle.readFile(),n=new DataView(e.buffer);if(n.getUint32(0,!0)!==It)throw new Error("Not a BAI file");const s=n.getInt32(4,!0),r=((1<<(5+1)*3)-1)/7;let c=8,a;const h=[];for(let l=0;l<s;l++){h.push(c);const f=n.getInt32(c,!0);c+=4;for(let m=0;m<f;m+=1){const g=n.getUint32(c,!0);if(c+=4,g===r+1)c+=4,c+=32;else{if(g>r+1)throw new Error("bai index contains too many bins, please use CSI");{const y=n.getInt32(c,!0);c+=4;for(let _=0;_<y;_++)c+=8,c+=8}}}const w=n.getInt32(c,!0);c+=4;const p=new Array(w);for(let m=0;m<w;m++){const g=S(e,c);c+=8,a=T(a,g),p[m]=g}}const u=new V({maxSize:5});function d(l){let f=h[l];if(f===void 0)return;const w=n.getInt32(f,!0);let p;f+=4;const m={};for(let _=0;_<w;_+=1){const I=n.getUint32(f,!0);if(f+=4,I===r+1)f+=4,p=X(e,f+16),f+=32;else{if(I>r+1)throw new Error("bai index contains too many bins, please use CSI");{const A=n.getInt32(f,!0);f+=4;const C=new Array(A);for(let R=0;R<A;R++){const v=S(e,f);f+=8;const k=S(e,f);f+=8,a=T(a,v),C[R]=new $(v,k,I)}m[I]=C}}}const g=n.getInt32(f,!0);f+=4;const y=new Array(g);for(let _=0;_<g;_++){const I=S(e,f);f+=8,a=T(a,I),y[_]=I}return{binIndex:m,linearIndex:y,stats:p}}return{bai:!0,firstDataLine:a,maxBlockSize:65536,indices:l=>{if(!u.has(l)){const f=d(l);return f&&u.set(l,f),f}return u.get(l)},refCount:s}}async indexCov(t,e,n,s){const r=e!==void 0,a=(await this.parse(s)).indices(t);if(!a)return[];const{linearIndex:h=[],stats:u}=a;if(h.length===0)return[];const d=n===void 0?(h.length-1)*16384:Pt(n,16384),l=e===void 0?0:At(e,16384),f=r?new Array((d-l)/16384):new Array(h.length-1),w=h[h.length-1].blockPosition;if(d>(h.length-1)*16384)throw new Error("query outside of range of linear index");let p=h[l/16384].blockPosition;for(let m=l/16384,g=0;m<d/16384;m++,g++)f[g]={score:h[m+1].blockPosition-p,start:m*16384,end:m*16384+16384},p=h[m+1].blockPosition;return f.map(m=>({...m,score:m.score*((u==null?void 0:u.lineCount)||0)/w}))}async blocksForRange(t,e,n,s={}){e<0&&(e=0);const i=await this.parse(s);if(!i)return[];const r=i.indices(t);if(!r)return[];const c=Ct(e,n),a=[];for(const[f,w]of c)for(let p=f;p<=w;p++)if(r.binIndex[p]){const m=r.binIndex[p];for(const g of m)a.push(new $(g.minv,g.maxv,p))}const h=r.linearIndex.length;let u;const d=Math.min(e>>14,h-1),l=Math.min(n>>14,h-1);for(let f=d;f<=l;++f){const w=r.linearIndex[f];w&&(!u||w.compareTo(u)<0)&&(u=w)}return K(a,u)}async parse(t={}){return this.setupP||(this.setupP=this._parse(t).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(t,e={}){var s;return!!((s=(await this.parse(e)).indices(t))!=null&&s.binIndex)}}function St(o){let t=0;for(const e of o)t+=e.length;return t}function et(o,t){const e=new Uint8Array(t??St(o));let n=0;for(const s of o)e.set(s,n),n+=s.length;return e}async function z(o){try{let t,e=0,n;const s=[];let i=0;do{const r=o.subarray(e);if(n=new Y(void 0),{strm:t}=n,n.push(r,W),n.err)throw new Error(n.msg);e+=t.next_in;const c=n.result;s.push(c),i+=c.length}while(t.avail_in);return et(s,i)}catch(t){throw/incorrect header check/.exec(`${t}`)?new Error("problem decompressing block: incorrect gzip header check"):t}}async function Rt(o,t,e){try{let n;const{minv:s,maxv:i}=t;let r=s.blockPosition,c=s.dataPosition;const a=[],h=[],u=[];let d=0,l=!1,f=0;do{const w=o.subarray(r-s.blockPosition),p=r.toString();let m,g;const y=e==null?void 0:e.get(p);if(y)m=y.buffer,g=y.nextIn,l=!0;else{const A=new Y(void 0);if({strm:n}=A,A.push(w,W),A.err)throw new Error(A.msg);m=A.result,g=n.next_in,l=!1,e==null||e.set(p,{buffer:m,nextIn:g})}a.push(m);let _=m.length;h.push(r),u.push(c),a.length===1&&s.dataPosition&&(a[0]=a[0].subarray(s.dataPosition),_=a[0].length);const I=r;if(r+=g,c+=_,I>=i.blockPosition){a[d]=a[d].subarray(0,i.blockPosition===s.blockPosition?i.dataPosition-s.dataPosition+1:i.dataPosition+1),f+=a[d].length,h.push(r),u.push(c);break}f+=_,d++}while(l?r<o.length+s.blockPosition:n.avail_in);return{buffer:et(a,f),cpositions:h,dpositions:u}}catch(n){throw/incorrect header check/.exec(`${n}`)?new Error("problem decompressing block: incorrect gzip header check"):n}}const vt=21582659,kt=38359875;function Ft(o,t){return o*2**t}function Q(o,t){return Math.floor(o/2**t)}class U extends J{constructor(){super(...arguments),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(t,e){var s,i;return((i=(s=(await this.parse(e)).indices(t))==null?void 0:s.stats)==null?void 0:i.lineCount)||0}async indexCov(){return[]}parseAuxData(t,e){const n=new DataView(t.buffer),s=n.getUint32(e,!0),i=s&65536?"zero-based-half-open":"1-based-closed",r={0:"generic",1:"SAM",2:"VCF"}[s&15];if(!r)throw new Error(`invalid Tabix preset format flags ${s}`);const c={ref:n.getInt32(e+4,!0),start:n.getInt32(e+8,!0),end:n.getInt32(e+12,!0)},a=n.getInt32(e+16,!0),h=a?String.fromCharCode(a):"",u=n.getInt32(e+20,!0),d=n.getInt32(e+24,!0);return{columnNumbers:c,coordinateType:i,metaValue:a,metaChar:h,skipLines:u,format:r,formatFlags:s,...xt(t.subarray(e+28,e+28+d),this.renameRefSeq)}}async _parse(t){const e=await this.filehandle.readFile(t),n=await z(e),s=new DataView(n.buffer);let i;const r=s.getUint32(0,!0);if(r===vt)i=1;else if(r===kt)i=2;else throw new Error(`Not a CSI file ${r}`);this.minShift=s.getInt32(4,!0),this.depth=s.getInt32(8,!0),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;const c=this.maxBinNumber,a=s.getInt32(12,!0),h=a>=30?this.parseAuxData(n,16):void 0,u=s.getInt32(16+a,!0);let d=16+a+4,l;const f=[];for(let m=0;m<u;m++){f.push(d);const g=s.getInt32(d,!0);d+=4;for(let y=0;y<g;y++){const _=s.getUint32(d,!0);if(d+=4,_>this.maxBinNumber)d+=44;else{d+=8;const I=s.getInt32(d,!0);d+=4;for(let A=0;A<I;A+=1){const C=S(n,d);d+=8,d+=8,l=T(l,C)}}}}const w=new V({maxSize:5});function p(m){let g=f[m];if(g===void 0)return;const y=s.getInt32(g,!0);g+=4;const _={};let I;for(let A=0;A<y;A++){const C=s.getUint32(g,!0);if(g+=4,C>c)I=X(n,g+28),g+=44;else{l=T(l,S(n,g)),g+=8;const R=s.getInt32(g,!0);g+=4;const v=new Array(R);for(let k=0;k<R;k+=1){const nt=S(n,g);g+=8;const st=S(n,g);g+=8,v[k]=new $(nt,st,C)}_[C]=v}}return{binIndex:_,stats:I}}return{csiVersion:i,firstDataLine:l,indices:m=>{if(!w.has(m)){const g=p(m);return g&&w.set(m,g),g}return w.get(m)},refCount:u,csi:!0,maxBlockSize:65536,...h}}async blocksForRange(t,e,n,s={}){e<0&&(e=0);const r=(await this.parse(s)).indices(t);if(!r)return[];const c=this.reg2bins(e,n);if(c.length===0)return[];const a=[];for(const[h,u]of c)for(let d=h;d<=u;d++)if(r.binIndex[d]){const l=r.binIndex[d];for(const f of l)a.push(f)}return K(a,new tt(0,0))}reg2bins(t,e){t-=1,t<1&&(t=1),e>2**50&&(e=2**34),e-=1;let n=0,s=0,i=this.minShift+this.depth*3;const r=[];for(;n<=this.depth;i-=3,s+=Ft(1,n*3),n+=1){const c=s+Q(t,i),a=s+Q(e,i);if(a-c+r.length>this.maxBinNumber)throw new Error(`query ${t}-${e} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);r.push([c,a])}return r}async parse(t={}){return this.setupP||(this.setupP=this._parse(t).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(t,e={}){var s;return!!((s=(await this.parse(e)).indices(t))!=null&&s.binIndex)}}class Et{read(){throw new Error("never called")}stat(){throw new Error("never called")}readFile(){throw new Error("never called")}close(){throw new Error("never called")}}var P={BAM_FPAIRED:1,BAM_FPROPER_PAIR:2,BAM_FUNMAP:4,BAM_FMUNMAP:8,BAM_FREVERSE:16,BAM_FMREVERSE:32,BAM_FREAD1:64,BAM_FREAD2:128,BAM_FSECONDARY:256,BAM_FQCFAIL:512,BAM_FDUP:1024,BAM_FSUPPLEMENTARY:2048},Tt=function(o,t,e,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?o!==t||!s:!t.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(o,e):s?s.value=e:t.set(o,e),e},x=function(o,t,e,n){if(e==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?o!==t||!n:!t.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(o):n?n.value:t.get(o)},b;const N="=ACMGRSVTWYHKDBN".split(""),E="MIDNSHP=X???????".split("");class M{constructor(t){b.set(this,void 0),this.bytes=t.bytes,this.fileOffset=t.fileOffset,Tt(this,b,new DataView(this.bytes.byteArray.buffer),"f")}get byteArray(){return this.bytes.byteArray}get flags(){return(x(this,b,"f").getInt32(this.bytes.start+16,!0)&4294901760)>>16}get ref_id(){return x(this,b,"f").getInt32(this.bytes.start+4,!0)}get start(){return x(this,b,"f").getInt32(this.bytes.start+8,!0)}get end(){return this.start+this.length_on_ref}get id(){return this.fileOffset}get mq(){const t=(this.bin_mq_nl&65280)>>8;return t===255?void 0:t}get score(){return this.mq}get qual(){if(this.isSegmentUnmapped())return;const t=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes;return this.byteArray.subarray(t,t+this.seq_length)}get strand(){return this.isReverseComplemented()?-1:1}get b0(){return this.bytes.start+36}get name(){let t="";for(let e=0;e<this.read_name_length-1;e++)t+=String.fromCharCode(this.byteArray[this.b0+e]);return t}get tags(){let t=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes+this.seq_length;const e=this.bytes.end,n={};for(;t<e;){const s=String.fromCharCode(this.byteArray[t],this.byteArray[t+1]),i=String.fromCharCode(this.byteArray[t+2]);if(t+=3,i==="A")n[s]=String.fromCharCode(this.byteArray[t]),t+=1;else if(i==="i")n[s]=x(this,b,"f").getInt32(t,!0),t+=4;else if(i==="I")n[s]=x(this,b,"f").getUint32(t,!0),t+=4;else if(i==="c")n[s]=x(this,b,"f").getInt8(t),t+=1;else if(i==="C")n[s]=x(this,b,"f").getUint8(t),t+=1;else if(i==="s")n[s]=x(this,b,"f").getInt16(t,!0),t+=2;else if(i==="S")n[s]=x(this,b,"f").getUint16(t,!0),t+=2;else if(i==="f")n[s]=x(this,b,"f").getFloat32(t,!0),t+=4;else if(i==="Z"||i==="H"){const r=[];for(;t<=e;){const c=this.byteArray[t++];if(c!==0)r.push(String.fromCharCode(c));else break}n[s]=r.join("")}else if(i==="B"){const r=this.byteArray[t++],c=String.fromCharCode(r),a=x(this,b,"f").getInt32(t,!0);if(t+=4,c==="i")if(s==="CG"){const h=[];for(let u=0;u<a;u++){const d=x(this,b,"f").getInt32(t,!0),l=d>>4,f=E[d&15];h.push(l+f),t+=4}n[s]=h.join("")}else{const h=[];for(let u=0;u<a;u++)h.push(x(this,b,"f").getInt32(t,!0)),t+=4;n[s]=h}else if(c==="I")if(s==="CG"){const h=[];for(let u=0;u<a;u++){const d=x(this,b,"f").getUint32(t,!0),l=d>>4,f=E[d&15];h.push(l+f),t+=4}n[s]=h.join("")}else{const h=[];for(let u=0;u<a;u++)h.push(x(this,b,"f").getUint32(t,!0)),t+=4;n[s]=h}else if(c==="s"){const h=[];for(let u=0;u<a;u++)h.push(x(this,b,"f").getInt16(t,!0)),t+=2;n[s]=h}else if(c==="S"){const h=[];for(let u=0;u<a;u++)h.push(x(this,b,"f").getUint16(t,!0)),t+=2;n[s]=h}else if(c==="c"){const h=[];for(let u=0;u<a;u++)h.push(x(this,b,"f").getInt8(t)),t+=1;n[s]=h}else if(c==="C"){const h=[];for(let u=0;u<a;u++)h.push(x(this,b,"f").getUint8(t)),t+=1;n[s]=h}else if(c==="f"){const h=[];for(let u=0;u<a;u++)h.push(x(this,b,"f").getFloat32(t,!0)),t+=4;n[s]=h}}else{console.error("Unknown BAM tag type",i);break}}return n}isPaired(){return!!(this.flags&P.BAM_FPAIRED)}isProperlyPaired(){return!!(this.flags&P.BAM_FPROPER_PAIR)}isSegmentUnmapped(){return!!(this.flags&P.BAM_FUNMAP)}isMateUnmapped(){return!!(this.flags&P.BAM_FMUNMAP)}isReverseComplemented(){return!!(this.flags&P.BAM_FREVERSE)}isMateReverseComplemented(){return!!(this.flags&P.BAM_FMREVERSE)}isRead1(){return!!(this.flags&P.BAM_FREAD1)}isRead2(){return!!(this.flags&P.BAM_FREAD2)}isSecondary(){return!!(this.flags&P.BAM_FSECONDARY)}isFailedQc(){return!!(this.flags&P.BAM_FQCFAIL)}isDuplicate(){return!!(this.flags&P.BAM_FDUP)}isSupplementary(){return!!(this.flags&P.BAM_FSUPPLEMENTARY)}get cigarAndLength(){if(this.isSegmentUnmapped())return{length_on_ref:0,CIGAR:""};const t=this.num_cigar_ops;let e=this.b0+this.read_name_length;const n=[];let s=x(this,b,"f").getInt32(e,!0),i=s>>4,r=E[s&15];if(r==="S"&&i===this.seq_length)return e+=4,s=x(this,b,"f").getInt32(e,!0),i=s>>4,r=E[s&15],r!=="N"&&console.warn("CG tag with no N tag"),{CIGAR:this.tags.CG,length_on_ref:i};{let c=0;for(let a=0;a<t;++a)s=x(this,b,"f").getInt32(e,!0),i=s>>4,r=E[s&15],n.push(i+r),r!=="H"&&r!=="S"&&r!=="I"&&(c+=i),e+=4;return{CIGAR:n.join(""),length_on_ref:c}}}get length_on_ref(){return this.cigarAndLength.length_on_ref}get CIGAR(){return this.cigarAndLength.CIGAR}get num_cigar_ops(){return this.flag_nc&65535}get read_name_length(){return this.bin_mq_nl&255}get num_seq_bytes(){return this.seq_length+1>>1}get seq(){const t=this.b0+this.read_name_length+this.num_cigar_ops*4,e=this.num_seq_bytes,n=this.seq_length,s=[];let i=0;for(let r=0;r<e;++r){const c=this.byteArray[t+r];s.push(N[(c&240)>>4]),i++,i<n&&(s.push(N[c&15]),i++)}return s.join("")}get pair_orientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this.ref_id===this.next_refid){const t=this.isReverseComplemented()?"R":"F",e=this.isMateReverseComplemented()?"R":"F";let n=" ",s=" ";this.isRead1()?(n="1",s="2"):this.isRead2()&&(n="2",s="1");const i=[];return this.template_length>0?(i[0]=t,i[1]=n,i[2]=e,i[3]=s):(i[2]=t,i[3]=n,i[0]=e,i[1]=s),i.join("")}}get bin_mq_nl(){return x(this,b,"f").getInt32(this.bytes.start+12,!0)}get flag_nc(){return x(this,b,"f").getInt32(this.bytes.start+16,!0)}get seq_length(){return x(this,b,"f").getInt32(this.bytes.start+20,!0)}get next_refid(){return x(this,b,"f").getInt32(this.bytes.start+24,!0)}get next_pos(){return x(this,b,"f").getInt32(this.bytes.start+28,!0)}get template_length(){return x(this,b,"f").getInt32(this.bytes.start+32,!0)}seqAt(t){if(t<this.seq_length){const e=t>>1,n=this.byteArray[this.b0+this.read_name_length+this.num_cigar_ops*4+e];return t%2===0?N[(n&240)>>4]:N[n&15]}else return}toJSON(){const t={};for(const e of Object.keys(this))e.startsWith("_")||e==="bytes"||(t[e]=this[e]);return t}}b=new WeakMap;function L(o,t){const e=Object.getOwnPropertyDescriptor(o.prototype,t);if(!e)throw new Error("OH NO, NO PROPERTY DESCRIPTOR");const n=e.get;if(!n)throw new Error("OH NO, NOT A GETTER");Object.defineProperty(o.prototype,t,{get(){const s=n.call(this);return Object.defineProperty(this,t,{value:s}),s}})}L(M,"tags");L(M,"cigarAndLength");L(M,"seq");L(M,"qual");function Mt(o){const t=o.split(/\r?\n/),e=[];for(const n of t){const[s,...i]=n.split(/\t/);s&&e.push({tag:s.slice(1),data:i.map(r=>{const c=r.indexOf(":"),a=r.slice(0,c),h=r.slice(c+1);return{tag:a,value:h}})})}return e}const qt=21840194,Bt=65536;class Dt{constructor({bamFilehandle:t,bamPath:e,bamUrl:n,baiPath:s,baiFilehandle:i,baiUrl:r,csiPath:c,csiFilehandle:a,csiUrl:h,htsget:u,yieldThreadTime:d=100,renameRefSeqs:l=f=>f}){if(this.htsget=!1,this.cache=new V({maxSize:1e3}),this.renameRefSeq=l,t)this.bam=t;else if(e)this.bam=new q(e);else if(n)this.bam=new B(n);else if(u)this.htsget=!0,this.bam=new Et;else throw new Error("unable to initialize bam");if(a)this.index=new U({filehandle:a});else if(c)this.index=new U({filehandle:new q(c)});else if(h)this.index=new U({filehandle:new B(h)});else if(i)this.index=new F({filehandle:i});else if(s)this.index=new F({filehandle:new q(s)});else if(r)this.index=new F({filehandle:new B(r)});else if(e)this.index=new F({filehandle:new q(`${e}.bai`)});else if(n)this.index=new F({filehandle:new B(`${n}.bai`)});else if(u)this.htsget=!0;else throw new Error("unable to infer index format");this.yieldThreadTime=d}async getHeaderPre(t){const e=bt(t);if(!this.index)return;const n=await this.index.parse(e),s=n.firstDataLine?n.firstDataLine.blockPosition+65535:void 0;let i;if(s){const l=s+Bt;i=await this.bam.read(l,0)}else i=await this.bam.readFile(e);const r=await z(i),c=new DataView(r.buffer);if(c.getInt32(0,!0)!==qt)throw new Error("Not a BAM file");const a=c.getInt32(4,!0),h=new TextDecoder("utf8");this.header=h.decode(r.subarray(8,8+a));const{chrToIndex:u,indexToChr:d}=await this._readRefSeqs(a+8,65535,e);return this.chrToIndex=u,this.indexToChr=d,Mt(this.header)}getHeader(t){return this.headerP||(this.headerP=this.getHeaderPre(t).catch(e=>{throw this.headerP=void 0,e})),this.headerP}async getHeaderText(t={}){return await this.getHeader(t),this.header}async _readRefSeqs(t,e,n){if(t>e)return this._readRefSeqs(t,e*2,n);const s=await this.bam.read(e,0,n),i=await z(s),r=new DataView(i.buffer),c=r.getInt32(t,!0);let a=t+4;const h={},u=[],d=new TextDecoder("utf8");for(let l=0;l<c;l+=1){const f=r.getInt32(a,!0),w=this.renameRefSeq(d.decode(i.subarray(a+4,a+4+f-1))),p=r.getInt32(a+f+4,!0);if(h[w]=l,u.push({refName:w,length:p}),a=a+8+f,a>i.length)return console.warn(`BAM header is very big.  Re-fetching ${e} bytes.`),this._readRefSeqs(t,e*2,n)}return{chrToIndex:h,indexToChr:u}}async getRecordsForRange(t,e,n,s){return yt(this.streamRecordsForRange(t,e,n,s))}async*streamRecordsForRange(t,e,n,s){var r;await this.getHeader(s);const i=(r=this.chrToIndex)==null?void 0:r[t];if(i===void 0||!this.index)yield[];else{const c=await this.index.blocksForRange(i,e-1,n,s);yield*this._fetchChunkFeatures(c,i,e,n,s)}}async*_fetchChunkFeatures(t,e,n,s,i={}){const{viewAsPairs:r}=i,c=[];let a=!1;for(const h of t){const{data:u,cpositions:d,dpositions:l}=await this._readChunk({chunk:h,opts:i}),f=await this.readBamFeatures(u,d,l,h),w=[];for(const p of f)if(p.ref_id===e)if(p.start>=s){a=!0;break}else p.end>=n&&w.push(p);if(c.push(w),yield w,a)break}pt(i.signal),r&&(yield this.fetchPairs(e,c,i))}async fetchPairs(t,e,n){const{pairAcrossChr:s,maxInsertSize:i=2e5}=n,r={},c={};e.map(l=>{const f={};for(const w of l){const p=w.name,m=w.id;f[p]||(f[p]=0),f[p]++,c[m]=1}for(const[w,p]of Object.entries(f))p===1&&(r[w]=!0)});const a=[];e.map(l=>{for(const f of l){const w=f.name,p=f.start,m=f.next_pos,g=f.next_refid;this.index&&r[w]&&(s||g===t&&Math.abs(p-m)<i)&&a.push(this.index.blocksForRange(g,m,m+1,n))}});const h=new Map,u=await Promise.all(a);for(const l of u.flat())h.has(l.toString())||h.set(l.toString(),l);return(await Promise.all([...h.values()].map(async l=>{const{data:f,cpositions:w,dpositions:p,chunk:m}=await this._readChunk({chunk:l,opts:n}),g=[];for(const y of await this.readBamFeatures(f,w,p,m))r[y.name]&&!c[y.id]&&g.push(y);return g}))).flat()}async _readChunk({chunk:t,opts:e}){const n=await this.bam.read(t.fetchedSize(),t.minv.blockPosition,e),{buffer:s,cpositions:i,dpositions:r}=await Rt(n,t,this.cache);return{data:s,cpositions:i,dpositions:r,chunk:t}}async readBamFeatures(t,e,n,s){let i=0;const r=[];let c=0,a=Date.now();const h=new DataView(t.buffer);for(;i+4<t.length;){const u=h.getInt32(i,!0),d=i+4+u-1;if(n){for(;i+s.minv.dataPosition>=n[c++];);c--}if(d<t.length){const l=new M({bytes:{byteArray:t,start:i,end:d},fileOffset:e.length>0?e[c]*256+(i-n[c])+s.minv.dataPosition+1:it(t.subarray(i,d))>>>0});r.push(l),this.yieldThreadTime&&Date.now()-a>this.yieldThreadTime&&(await mt(1),a=Date.now())}i=d+1}return r}async hasRefSeq(t){var n,s;const e=(n=this.chrToIndex)==null?void 0:n[t];return e===void 0?!1:(s=this.index)==null?void 0:s.hasRefSeq(e)}async lineCount(t){var n;const e=(n=this.chrToIndex)==null?void 0:n[t];return e===void 0||!this.index?0:this.index.lineCount(e)}async indexCov(t,e,n){var i;if(!this.index)return[];await this.index.parse();const s=(i=this.chrToIndex)==null?void 0:i[t];return s===void 0?[]:this.index.indexCov(s,e,n)}async blocksForRange(t,e,n,s){var r;if(!this.index)return[];await this.index.parse();const i=(r=this.chrToIndex)==null?void 0:r[t];return i===void 0?[]:this.index.blocksForRange(i,e,n,s)}}class G{constructor(t,e,n){this.record=t,this.adapter=e,this.ref=n}id(){return`${this.adapter.id}-${this.record.id}`}get mismatches(){return ot(this.record.CIGAR,this.record.tags.MD,this.record.seq,this.ref,this.record.qual)}get qual(){var t;return(t=this.record.qual)===null||t===void 0?void 0:t.join(" ")}get(t){return t==="mismatches"?this.mismatches:t==="qual"?this.qual:this.fields[t]}parent(){}children(){}get fields(){const t=this.record,e=this.adapter,n=t.isPaired();return{start:t.start,name:t.name,end:t.end,score:t.score,strand:t.strand,template_length:t.template_length,flags:t.flags,tags:t.tags,refName:e.refIdToName(t.ref_id),CIGAR:t.CIGAR,seq:t.seq,type:"match",pair_orientation:t.pair_orientation,next_ref:n?e.refIdToName(t.next_refid):void 0,next_pos:n?t.next_pos:void 0,next_segment_position:n?`${e.refIdToName(t.next_refid)}:${t.next_pos+1}`:void 0,uniqueId:this.id()}}toJSON(){return{...this.fields,qual:this.qual}}}Z(G,"fields");Z(G,"mismatches");class Nt extends rt.BaseFeatureDataAdapter{constructor(){super(...arguments),this.ultraLongFeatureCache=new ft({maxSize:500})}async configurePre(){const t=this.getConf("bamLocation"),e=this.getConf(["index","location"]),n=this.getConf(["index","indexType"]),s=this.pluginManager,i=n==="CSI",r=new Dt({bamFilehandle:O.openLocation(t,s),csiFilehandle:i?O.openLocation(e,s):void 0,baiFilehandle:i?void 0:O.openLocation(e,s),yieldThreadTime:Number.POSITIVE_INFINITY}),c=this.getConf("sequenceAdapter");if(c&&this.getSubAdapter){const{dataAdapter:a}=await this.getSubAdapter(c);return{bam:r,sequenceAdapter:a}}return{bam:r}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(t=>{throw this.configureP=void 0,t})),this.configureP}async getHeader(t){const{bam:e}=await this.configure();return e.getHeaderText()}async setupPre(t){const{bam:e}=await this.configure(),n=await e.getHeader(),s=[],i={};if(n)for(const[r,c]of n.filter(a=>a.tag==="SQ").entries()){const a=c.data.find(h=>h.tag==="SN");if(a){const h=a.value;i[h]=r,s[r]=h}}return this.samHeader={idToName:s,nameToId:i},this.samHeader}async setupPre2(t){return this.setupP||(this.setupP=this.setupPre(t).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async setup(t){const{statusCallback:e=()=>{}}=t||{};return D.updateStatus("Downloading index",e,()=>this.setupPre2(t))}async getRefNames(t){const{idToName:e}=await this.setup(t);return e}async seqFetch(t,e,n){const{sequenceAdapter:s}=await this.configure(),i=s;if(!i||!t)return;const r=i.getFeatures({refName:t,start:e,end:n,assemblyName:""}),c=await at(r.pipe(ct()));let a="";for(const h of c.sort((u,d)=>u.get("start")-d.get("start"))){const u=h.get("start"),d=h.get("end"),l=Math.max(e-u,0),w=Math.min(n-u,d-u)-l,p=h.get("seq")||h.get("residues");a+=p.slice(l,l+w)}if(a.length!==n-e)throw new Error(`sequence fetch failed: fetching ${t}:${(e-1).toLocaleString()}-${n.toLocaleString()} returned ${a.length.toLocaleString()} bases, but should have returned ${(n-e).toLocaleString()}`);return a}getFeatures(t,e){const{refName:n,start:s,end:i,originalRefName:r}=t,{stopToken:c,filterBy:a,statusCallback:h=()=>{}}=e||{};return lt.ObservableCreate(async u=>{const{bam:d}=await this.configure();await this.setup(e),j.checkStopToken(c);const l=await D.updateStatus("Downloading alignments",h,()=>d.getRecordsForRange(n,s,i));j.checkStopToken(c),await D.updateStatus("Processing alignments",h,async()=>{const{flagInclude:f=0,flagExclude:w=0,tagFilter:p,readName:m}=a||{};for(const g of l){let y;if(g.tags.MD||(y=await this.seqFetch(r||n,g.start,g.end)),ht(g.flags,f,w)||p&&ut(g.tags[p.tag],p.value)||m&&g.name!==m)continue;const _=this.ultraLongFeatureCache.get(`${g.id}`);if(_)u.next(_);else{const I=new G(g,this,y);this.ultraLongFeatureCache.set(`${g.id}`,I),u.next(I)}}u.complete()})})}async getMultiRegionFeatureDensityStats(t,e){const{bam:n}=await this.configure();if(n.index){const s=await D.bytesForRegions(t,n),i=this.getConf("fetchSizeLimit");return{bytes:s,fetchSizeLimit:i}}return super.getMultiRegionFeatureDensityStats(t,e)}refIdToName(t){var e;return(e=this.samHeader)===null||e===void 0?void 0:e.idToName[t]}}var Yt=Object.freeze({__proto__:null,default:Nt});export{Dt as B,qt as a,Nt as b,Qt as c,Yt as d,Mt as p,z as u};
//# sourceMappingURL=BamAdapter-Cb5JYnqC.js.map
