import{R as q,u as w,ap as U,ac as V}from"./index-DUxFddIG.js";import{d as X,f as y,g as Y,a as Z}from"./drawPhased-DvrNuell.js";async function et(p,T){const{scrollTop:G,minorAlleleFrequencyFilter:K,sources:M,rowHeight:f,features:O,regions:W,bpPerPx:z,renderingMode:B,stopToken:u,lengthCutoffFilter:J,referenceDrawingMode:F}=T,N=W[0],{statusCallback:S=()=>{}}=T;q.checkStopToken(u);const E=await w.updateStatus("Calculating stats",S,()=>U({stopToken:u,features:O.values(),minorAlleleFrequencyFilter:K,lengthCutoffFilter:J}));q.checkStopToken(u);const n=[],h=[],A={};await w.updateStatus("Drawing variants",S,()=>{w.forEachWithStopTokenCheck(E,u,({mostFrequentAlt:t,feature:o})=>{const[x,Q]=w.featureSpanPx(o,N,z),j=o.id(),P=o.get("end")-o.get("start"),d=Math.max(Math.round(Q-x),2),D=o.get("genotypes");let e=-G;const R=M.length;if(B==="phased")for(let a=0;a<R;a++){const{name:g,HP:c}=M[a],s=D[g],l=Math.floor(x),i=Math.max(f,1);if(s)if(s.includes("|")){const k=s.split("|");X(k,p,l,e,d,i,c,void 0,F==="draw")&&(h.push({name:g,genotype:s,featureId:j,bpLen:P}),n.push(l,e,l+d,e+i))}else p.fillStyle="black",p.fillRect(l-y,e-y,d+y,i+y);e+=f}else for(let a=0;a<R;a++){const{name:g}=M[a],c=D[g],s=Math.floor(x),l=Math.max(f,1);if(c){const i=`${c}:${t}`;let r=A[i];if(r===void 0){let k=0,v=0,H=0,I=0;const L=c.split(/[/|]/),$=L.length;for(let C=0;C<$;C++){const b=L[C];b===t?k++:b==="0"?I++:b==="."?v++:H++}r=Y(I,k,H,v,$,F==="draw"),A[i]=r}r&&(Z(r,p,s,e,d,l,o.get("type"),o.get("strand"),P>5?.75:1),h.push({name:g,genotype:c,featureId:j,bpLen:P}),n.push(s,e,s+d,e+l))}e+=f}})});const m=new V(Math.max(h.length,1));if(h.length)for(let t=0;t<n.length;t+=4)m.add(n[t],n[t+1],n[t+2],n[t+3]);else m.add(0,0);return m.finish(),{flatbush:m.data,items:h,featureGenotypeMap:Object.fromEntries(E.map(({feature:t})=>[t.id(),{alt:t.get("ALT"),ref:t.get("REF"),name:t.get("name"),description:t.get("description"),length:t.get("end")-t.get("start")}]))}}export{et as makeImageData};
//# sourceMappingURL=makeImageData-BUyLI23y.js.map
