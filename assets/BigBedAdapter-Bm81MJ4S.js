var z=Object.defineProperty;var R=(y,e,t)=>e in y?z(y,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):y[e]=t;var U=(y,e,t)=>R(y,typeof e!="symbol"?e+"":e,t);import{B as $}from"./bbi-BVQoNgLY.js";import{A as H}from"./AbortablePromiseCache-Bzbqdtb1.js";import{Q as j}from"./index-Cq2N9pGB.js";import{O as L}from"./Observable-5uESDskq.js";import{ap as M,f as D,i as q,t as _,u as b}from"./rpcWorker-X0469dqW.js";import{a as G,m as J}from"./merge-C2TxsTRC.js";import{B as Y,a as X}from"./util-CwTKo8hx.js";import{B as K}from"./index-DYe7vadA.js";import{r as Q}from"./rxjs-DQbUCOsY.js";import"./browser-DdKr-yeI.js";import"./inflate-XVoSut8N.js";import"./remoteFile-B4_2tkev.js";function W(y){return y.filter(e=>!!e)}class Z extends ${constructor(){super(...arguments);U(this,"readIndicesCache",new H({cache:new j({maxSize:1}),fill:(t,a)=>this._readIndices({...t,signal:a})}))}readIndices(t={}){const{signal:a,...s}=t;return this.readIndicesCache.get(JSON.stringify(s),t,a)}async getView(t,a){return this.getUnzoomedView(a)}async _readIndices(t){const{extHeaderOffset:a}=await this.getHeader(t),s=await this.bbi.read(64,a),c=new DataView(s.buffer,s.byteOffset,s.length);let l=0;l+=2;const w=c.getUint16(l,!0);l+=2;const p=Number(c.getBigUint64(l,!0));if(l+=8,w===0)return[];const f=20,g=f*w,x=await this.bbi.read(g,p),d=[];for(let I=0;I<w;I+=1){const m=x.subarray(I*f),r=new DataView(m.buffer,m.byteOffset,m.length);let i=0;const u=r.getInt16(i,!0);i+=2;const h=r.getInt16(i,!0);i+=2;const N=Number(r.getBigUint64(i,!0));i+=12;const B=r.getInt16(i,!0);d.push({type:u,fieldcount:h,offset:N,field:B})}return d}async searchExtraIndexBlocks(t,a={}){const s=await this.readIndices(a);if(s.length===0)return[];const c=new TextDecoder("utf8"),l=s.map(async w=>{const{offset:p,field:f}=w,g=await this.bbi.read(32,p,a),x=new DataView(g.buffer,g.byteOffset,g.length);let d=0;d+=4;const I=x.getInt32(d,!0);d+=4;const m=x.getInt32(d,!0);d+=4;const r=x.getInt32(d,!0);d+=4,d+=8;const i=async u=>{const h=u,N=4+I*(m+r),S=await this.bbi.read(N,h,a),o=new DataView(S.buffer,S.byteOffset,S.length);let n=0;const O=o.getInt8(n);n+=2;const A=o.getInt16(n,!0);n+=2;const C=[];if(O===0){const k=[];for(let F=0;F<A;F++){const V=c.decode(S.subarray(n,n+m)).replaceAll("\0","");n+=m;const P=Number(o.getBigUint64(n,!0));n+=8,k.push({key:V,offset:P})}let E=0;for(const{key:F,offset:V}of k){if(t.localeCompare(F)<0&&E)return i(E);E=V}return i(E)}else if(O===1){for(let k=0;k<A;k++){const E=c.decode(S.subarray(n,n+m)).replaceAll("\0","");n+=m;const F=Number(o.getBigUint64(n,!0));n+=8;const V=o.getUint32(n,!0);n+=4;const P=o.getUint32(n,!0);n+=4,C.push({key:E,offset:F,length:V,reserved:P})}for(const k of C)if(k.key===t)return{...k,field:f};return}};return i(p+32)});return W(await Promise.all(l))}async searchExtraIndex(t,a={}){const s=await this.searchExtraIndexBlocks(t,a);if(s.length===0)return[];const c=await this.getUnzoomedView(a),l=s.map(p=>new L(f=>{c.readFeatures(f,[p],a).catch(g=>{f.error(g)})}).pipe(M((f,g)=>f.concat(g)),G(f=>{for(const g of f)g.field=p.field;return f})));return(await D(J(...l))).filter(p=>{var f;return((f=p.rest)==null?void 0:f.split("	")[(p.field||0)-3])===t})}}class he extends K.BaseFeatureDataAdapter{async configurePre(e){const t=this.pluginManager,a=new Z({filehandle:q.openLocation(this.getConf("bigBedLocation"),t)}),s=await a.getHeader(e),c=new Y({autoSql:s.autoSql});return{bigbed:a,header:s,parser:c}}async configure(e){return this.cachedP||(this.cachedP=this.configurePre(e).catch(t=>{throw this.cachedP=void 0,t})),this.cachedP}async getRefNames(e){const{header:t}=await this.configure(e);return Object.keys(t.refsByName)}async getRefNameAliases(e){const{header:t}=await this.configure(e);return(await Promise.all(Object.keys(t.refsByName).map(async s=>(await D(this.getFeatures({assemblyName:"",refName:s,start:0,end:1}).pipe(_())))[0]))).map(s=>s.toJSON()).map(s=>({refName:s.ucsc,aliases:[s.ncbi,s.refseq,s.genbank],override:!0}))}async getData(){const e=await this.getRefNames(),t=[];for(const a of e){const s=await D(this.getFeatures({assemblyName:"unknown",refName:a,start:0,end:Number.MAX_SAFE_INTEGER}).pipe(_()));t.push(s)}return t.flat()}async getHeader(e){const{parser:t,header:a}=await this.configure(e),{version:s,fileType:c}=a,{fields:l,...w}=t.autoSql;return{version:s,fileType:c,autoSql:w,fields:await this.getMetadata(e)}}async getMetadata(e){const{parser:t}=await this.configure(e),{fields:a}=t.autoSql;return Object.fromEntries(a.map(({name:s,comment:c})=>[s,c]))}async getFeaturesHelper({query:e,opts:t,observer:a,allowRedispatch:s,originalQuery:c=e}){const{statusCallback:l=()=>{}}=t,w=this.getConf("scoreColumn"),p=this.getConf("aggregateField"),{parser:f,bigbed:g}=await b.updateStatus("Downloading header",l,()=>this.configure(t)),x=await b.updateStatus("Downloading features",l,()=>g.getFeatures(e.refName,e.start,e.end,{basesPerSpan:e.end-e.start}));await b.updateStatus("Processing features",l,async()=>{var d;const I={},m=[];if(x.some(r=>r.uniqueId===void 0))throw new Error("found uniqueId undefined");for(const r of x){const i=[e.refName,`${r.start}`,`${r.end}`,...((d=r.rest)===null||d===void 0?void 0:d.split("	"))||[]],u=f.parseLine(i,{uniqueId:r.uniqueId}),h=u[p],N=h&&h!=="none";N&&!I[h]&&(I[h]=[]);const{uniqueId:B,type:S,chrom:o,chromStart:n,chromEnd:O,description:A,chromStarts:C,blockStarts:k,blockSizes:E,score:F,blockCount:V,thickStart:P,thickEnd:ee,strand:te,...T}=u,v=X({...T,scoreColumn:w,splitLine:i,parser:f,uniqueId:B,start:r.start,end:r.end,refName:e.refName});N?(I[h].push(v),m.push(v)):b.doesIntersect2(v.start,v.end,c.start,c.end)&&a.next(new b.SimpleFeature({id:`${this.id}-${B}`,data:v}))}if(s&&m.length){let r=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;for(const u of m)u.start<r&&(r=u.start),u.end>i&&(i=u.end);if(i>e.end||r<e.start){await this.getFeaturesHelper({query:{...e,start:r-5e5,end:i+5e5},opts:t,observer:a,allowRedispatch:!1,originalQuery:e});return}}Object.entries(I).map(([r,i])=>{var u,h,N;const B=b.min(i.map(o=>o.start)),S=b.max(i.map(o=>o.end));if(b.doesIntersect2(B,S,c.start,c.end)){const o=i.sort((n,O)=>n.uniqueId.localeCompare(O.uniqueId));if(o.some((n,O)=>o.some((A,C)=>O!==C&&b.doesIntersect2(n.start,n.end,A.start,A.end))))a.next(new b.SimpleFeature({id:`${this.id}-${(u=o[0])===null||u===void 0?void 0:u.uniqueId}-parent`,data:{type:"gene",subfeatures:o,strand:((h=o[0])===null||h===void 0?void 0:h.strand)||1,name:r,start:B,end:S,refName:e.refName}}));else for(const n of o)a.next(new b.SimpleFeature({id:`${this.id}-${n.uniqueId}-parent`,data:{type:"gene",subfeatures:[n],strand:((N=o[0])===null||N===void 0?void 0:N.strand)||1,name:r,start:n.start,end:n.end,refName:e.refName}}))}})}),a.complete()}getFeatures(e,t={}){return Q.ObservableCreate(async a=>{try{await this.getFeaturesHelper({query:{...e,start:e.start,end:e.end},opts:t,observer:a,allowRedispatch:!0})}catch(s){a.error(s)}},t.stopToken)}}export{he as default};
//# sourceMappingURL=BigBedAdapter-Bm81MJ4S.js.map
