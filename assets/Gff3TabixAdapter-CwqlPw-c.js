import{T as I}from"./tabixIndexedFile-BJZaVbrN.js";import{B as S}from"./index-DYe7vadA.js";import{ax as F,i as g,u as h}from"./rpcWorker-X0469dqW.js";import{r as T}from"./rxjs-DQbUCOsY.js";import{S as C}from"./simpleFeature-B9zOvlHc.js";import{p as L,f as N}from"./featureData-DYx9FRRX.js";import"./AbortablePromiseCache-Bzbqdtb1.js";import"./index-FiHv7a3v.js";import"./browser-DdKr-yeI.js";import"./remoteFile-B4_2tkev.js";var E=F();class j extends S.BaseFeatureDataAdapter{async configurePre(e){const t=this.getConf("gffGzLocation"),i=this.getConf(["index","indexType"]),n=this.getConf(["index","location"]),f=this.getConf("dontRedispatch"),c=new I({filehandle:g.openLocation(t,this.pluginManager),csiFilehandle:i==="CSI"?g.openLocation(n,this.pluginManager):void 0,tbiFilehandle:i!=="CSI"?g.openLocation(n,this.pluginManager):void 0,chunkCacheSize:50*2**20,renameRefSeqs:d=>d});return{gff:c,dontRedispatch:f,header:await c.getHeader()}}async configurePre2(){return this.configured||(this.configured=this.configurePre().catch(e=>{throw this.configured=void 0,e})),this.configured}async configure(e){const{statusCallback:t=()=>{}}=e||{};return h.updateStatus("Downloading index",t,()=>this.configurePre2())}async getRefNames(e={}){const{gff:t}=await this.configure(e);return t.getReferenceSequenceNames(e)}async getHeader(e={}){const{gff:t}=await this.configure(e);return t.getHeader()}getFeatures(e,t={}){return T.ObservableCreate(async i=>{const{gff:n}=await this.configure(t),f=await n.getMetadata();await this.getFeaturesHelper(e,t,f,i,!0)},t.stopToken)}async getFeaturesHelper(e,t,i,n,f,c=e){var d,u;const{statusCallback:p=()=>{}}=t;try{const o=[],{dontRedispatch:m,gff:x}=await this.configure(t);if(await h.updateStatus("Downloading features",p,()=>x.getLines(e.refName,e.start,e.end,(a,s)=>{o.push(this.parseLine(i.columnNumbers,a,s))})),f&&o.length){let a=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const r of o){const H=r.fields[2];if(!m.includes(H)){const l=r.start-1;l<a&&(a=l),r.end>s&&(s=r.end)}}if(s>e.end||a<e.start){await this.getFeaturesHelper({...e,start:a,end:s},t,i,n,!1,e);return}}const w=o.map(a=>(a.fields[8]&&a.fields[8]!=="."?a.fields[8].includes("_lineHash")||(a.fields[8]+=`;_lineHash=${a.lineHash}`):a.fields[8]=`_lineHash=${a.lineHash}`,a.fields.join("	"))).join(`
`);for(const a of L(w))for(const s of a){const r=new C({data:N(s),id:`${this.id}-offset-${(u=(d=s.attributes)===null||d===void 0?void 0:d._lineHash)===null||u===void 0?void 0:u[0]}`});E.doesIntersect2(r.get("start"),r.get("end"),c.start,c.end)&&n.next(r)}n.complete()}catch(o){n.error(o)}}parseLine(e,t,i){const n=t.split("	");return{start:+n[e.start-1],end:+n[e.end-1],lineHash:i,fields:n}}}export{j as default};
//# sourceMappingURL=Gff3TabixAdapter-CwqlPw-c.js.map
