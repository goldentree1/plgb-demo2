import{bx as B,u as V,s as z,by as K,ac as q}from"./index-DUxFddIG.js";import{c as D,f as G,s as J,d as Q,e as W,P as Z}from"./color-CtySM7W0.js";function A(n,t,o,e,a,i){o<0&&(n+=o,o=-o),e<0&&(t+=e,e=-e),i&&(a.fillStyle=i),a.fillRect(n,t,o,e)}function U(n,t,o,e,a,i){o<0&&(n+=o,o=-o),e<0&&(t+=e,e=-e),i&&(a.strokeStyle=i),a.strokeRect(n,t,o,e)}function j(n,t,o,e,a,i,l,s,d){n.fillStyle=l,n.beginPath(),i===-1?(n.moveTo(t-s,o+a/2),n.lineTo(t,o+a),n.lineTo(t+e,o+a),n.lineTo(t+e,o),n.lineTo(t,o)):(n.moveTo(t,o),n.lineTo(t,o+a),n.lineTo(t+e,o+a),n.lineTo(t+e+s,o+a/2),n.lineTo(t+e,o)),n.closePath(),n.fill(),d&&(n.strokeStyle=d,n.stroke())}function $(n){var t,o;return n.flags&2048?((o=(t=n.SA)===null||t===void 0?void 0:t.split(";")[0])===null||o===void 0?void 0:o.split(",")[2])==="-"?-1:1:n.flags&16?-1:1}function H({ctx:n,chainData:t,view:o,asm:e,chainYOffsets:a,renderChevrons:i,featureHeight:l,featuresForFlatbush:s,computedChains:d,flipStrandLongReadChains:r}){var f,u;const N=S=>S===-1?"color_rev_strand":"color_fwd_strand";for(const S of d){const{id:g,chain:c,minX:x,maxX:v}=S;let p=!1;for(const h of c)if(h.flags&1){p=!0;break}if(p)continue;const m=a.get(g);if(m===void 0)continue;const y=[];for(const h of c)h.flags&2048||y.push(h);const X=c.length===1,I=y[0]||c[0],_=$(I);if(!X){const h=c[0],C=c[c.length-1],P=(f=o.bpToPx({refName:e.getCanonicalRefName2(h.refName),coord:h.start}))===null||f===void 0?void 0:f.offsetPx,M=(u=o.bpToPx({refName:e.getCanonicalRefName2(C.refName),coord:C.end}))===null||u===void 0?void 0:u.offsetPx;if(P!==void 0&&M!==void 0){const T=m+l/2-.5;n.beginPath(),n.strokeStyle="#666",n.moveTo(P-o.offsetPx,T),n.lineTo(M-o.offsetPx,T),n.stroke()}}const k=o.offsetPx,L=x-k,b=v-k;for(let h=0,C=c.length;h<C;h++){const P=c[h],M=o.bpToPx({refName:e.getCanonicalRefName2(P.refName),coord:P.start}),T=o.bpToPx({refName:e.getCanonicalRefName2(P.refName),coord:P.end});if(!M||!T)continue;const R=X||!r?P.strand:P.strand*_,[O,Y]=X?D(P,t.stats):[G[N(R)],J[N(R)]],F=M.offsetPx-k,E=Math.max(T.offsetPx-M.offsetPx,3);i?j(n,F,m,E,l,R,O,B,Y):(A(F,m,E,l,n,O),U(F,m,E,l,n,Y)),s.push({x1:F,y1:m,x2:F+E,y2:m+l,data:P,chainId:g,chainMinX:L,chainMaxX:b,chain:c})}}}function w({ctx:n,type:t,chainData:o,view:e,asm:a,chainYOffsets:i,renderChevrons:l,featureHeight:s,featuresForFlatbush:d,computedChains:r}){var f,u;for(const N of r){const{id:S,chain:g,minX:c,maxX:x}=N;let v=!1;for(const b of g)if(b.flags&1){v=!0;break}if(!v)continue;const p=i.get(S);if(p===void 0)continue;const m=[];for(const b of g)b.flags&2048||m.push(b);const y=m.length===2,[X,I]=y?Q({type:t,v0:m[0],v1:m[1],stats:o.stats})||["#888","#888"]:D(m[0]||g[0],o.stats);if(y){const b=m[0],h=m[1],C=(f=e.bpToPx({refName:a.getCanonicalRefName2(b.refName),coord:b.start}))===null||f===void 0?void 0:f.offsetPx,P=(u=e.bpToPx({refName:a.getCanonicalRefName2(h.refName),coord:h.start}))===null||u===void 0?void 0:u.offsetPx;C!==void 0&&P!==void 0&&A(C-e.offsetPx,p+s/2-.5,P-C,1,n,"#666")}const _=e.offsetPx,k=c-_,L=x-_;for(let b=0,h=g.length;b<h;b++){const C=g[b],P=e.bpToPx({refName:a.getCanonicalRefName2(C.refName),coord:C.start}),M=e.bpToPx({refName:a.getCanonicalRefName2(C.refName),coord:C.end});if(!P||!M)continue;const T=P.offsetPx-_,R=Math.max(M.offsetPx-P.offsetPx,3);l?j(n,T,p,R,s,C.strand,X,B,I):(A(T,p,R,s,n,X),U(T,p,R,s,n,I)),d.push({x1:T,y1:p,x2:T+R,y2:p+s,data:C,chainId:S,chainMinX:k,chainMaxX:L,chain:g})}}}function nn(n,t,o,e,a){const i=[];for(const l of n){const s=l;if(!t&&s.length===1)continue;let d=!1;for(const r of s)if(r.flags&1){d=!0;break}if(!o&&d){const r=[];for(const f of s)f.flags&2048||r.push(f);if(r.length===2){const f=r[0],u=r[1];if(W({type:e,f1:f,f2:u,stats:a.stats})===Z.PROPER_PAIR)continue}}i.push(s)}return i}function on(n,t,o){var e,a;const i=[];for(const l of n){const s=l;let d=Number.MAX_VALUE,r=Number.MIN_VALUE,f="",u=0;const N=s.length;for(let g=0;g<N;g++){const c=s[g],x=o.getCanonicalRefName(c.refName)||c.refName,v=(e=t.bpToPx({refName:x,coord:c.start}))===null||e===void 0?void 0:e.offsetPx,p=(a=t.bpToPx({refName:x,coord:c.end}))===null||a===void 0?void 0:a.offsetPx;v!==void 0&&p!==void 0&&(d=Math.min(d,v),r=Math.max(r,p)),f||(f=c.id),N>1&&u===0&&c.tlen&&(u=Math.abs(c.tlen))}const S=u>0?u:Math.abs(r-d);i.push({distance:S,minX:d,maxX:r,chain:s,id:f})}return i}function en(n){n.sort((t,o)=>{const e=t.chain.length===1?1:0,a=o.chain.length===1?1:0;return a!==e?a-e:t.distance-o.distance})}function tn(n,t){const o=new q(Math.max(n.length,1)),e=n.length;if(e)for(let a=0;a<e;a++){const{x1:i,y1:l,x2:s,y2:d}=n[a];o.add(i,l,s,d)}else o.add(0,0);o.finish(),t.setFeatureLayout(o),t.setFeaturesForFlatbush(n)}function an(n,t,o,e,a){for(const i of n){const{id:l,chain:s,minX:d,maxX:r}=i,f=t.get(l);if(f===void 0)continue;const u=d-e.offsetPx,N=r-e.offsetPx;s.length>0&&a.push({x1:u,y1:f,x2:N,y2:f+o,data:s[0],chainId:l,chainMinX:u,chainMaxX:N,chain:s})}}function rn(n,t,o){var e,a;const{chainData:i}=n;if(!i)return;const{assemblyManager:l}=V.getSession(n),s=V.getContainingView(n),d=s.assemblyNames[0],r=l.get(d);if(!r)return;const f=(e=n.featureHeight)!==null&&e!==void 0?e:z.getConf(n,"featureHeight"),u=((a=n.colorBy)===null||a===void 0?void 0:a.type)||"insertSizeAndOrientation",N=n.drawSingletons,S=n.drawProperPairs,{chains:g}=i,c=nn(g,N,S,u,i),x=on(c,s,r);en(x);const{chainYOffsets:v,layoutHeight:p}=o(x,n,s,f),m=[],y=K(s.bpPerPx,f);w({ctx:t,type:u,chainData:i,view:s,asm:r,chainYOffsets:v,renderChevrons:y,featureHeight:f,featuresForFlatbush:m,computedChains:x}),H({ctx:t,chainData:i,view:s,asm:r,chainYOffsets:v,renderChevrons:y,featureHeight:f,featuresForFlatbush:m,computedChains:x,flipStrandLongReadChains:n.flipStrandLongReadChains}),an(x,v,f,s,m),tn(m,n),p!==void 0&&n.setLayoutHeight(p)}export{rn as d};
//# sourceMappingURL=drawFeatsCommon-C0l28OJR.js.map
