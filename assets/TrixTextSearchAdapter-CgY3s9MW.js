var A=Object.defineProperty;var B=(i,e,t)=>e in i?A(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var x=(i,e,t)=>B(i,typeof e!="symbol"?e+"":e,t);import{d as g,i as I,aZ as E}from"./rpcWorker-X0469dqW.js";import{B as O}from"./index-DYe7vadA.js";function T(i,e=JSON.stringify){const t=[],s=new Set;for(const o of i){const r=e(o);s.has(r)||(t.push(o),s.add(r))}return t}function k(i){let e=0;for(const t of i)e+=t.length;return e}function U(i){const e=new Uint8Array(k(i));let t=0;for(const s of i)e.set(s,t),t+=s.length;return e}const S=65536,N=10;class v{constructor(e,t,s=20){x(this,"ixxFile");x(this,"ixFile");x(this,"maxResults");x(this,"decoder",new TextDecoder("utf8"));x(this,"indexCache");x(this,"ixFileSize");this.ixxFile=e,this.ixFile=t,this.maxResults=s}async getIxFileSize(e){if(this.ixFileSize!==void 0)return this.ixFileSize;try{const t=await this.ixFile.stat(e);return this.ixFileSize=t.size,this.ixFileSize}catch{return}}async search(e,t){let s=[];const r=e.split(" ")[0];if(r){const n=r.toLowerCase(),l=await this.getBuffer(n,t);let{end:c,buffer:d}=l;const{fileSize:h}=l;let f=!1;for(;!f;){const y=this.decoder.decode(d),F=y.slice(0,y.lastIndexOf(`
`)).split(`
`).filter(Boolean),w=[];for(const m of F){const a=m.split(" ")[0];a.startsWith(n)?w.push(m):a>n&&(f=!0)}const C=w.flatMap(m=>{const[a,...z]=m.split(" ");return z.filter(Boolean).map(R=>[a,R.split(",")[0]])});if(s=s.concat(C),f||s.length>=this.maxResults||h!==void 0&&c>=h)break;let p=S;h!==void 0&&(p=Math.min(S,h-c));const u=await this.ixFile.read(p,c,t);if(u.length===0)break;d=U([d,u]),c+=u.length}}return T(s,n=>n[1]).slice(0,this.maxResults)}async getIndex(e){if(this.indexCache)return this.indexCache;const s=(await this.ixxFile.readFile({encoding:"utf8",...e})).split(`
`).filter(Boolean).map(o=>{const r=o.length-N,n=o.slice(0,r),l=o.slice(r),c=Number.parseInt(l,16);return[n,c]});return this.indexCache=s,s}async getBuffer(e,t){let s=0,o=S;const r=await this.getIndex(t);for(const[c,d]of r)c.slice(0,e.length)<e&&(s=d,o=d+S);const n=await this.getIxFileSize(t);return n!==void 0&&(o=Math.min(o,n)),{buffer:await this.ixFile.read(o-s,s,t),end:o,fileSize:n}}}function b(i){try{return decodeURIComponent(i)}catch{return i}}function L(i,e,t=15){const s=i.toLowerCase().indexOf(e);return i.length<40?i:(Math.max(0,s-t)>0?"...":"")+i.slice(Math.max(0,s-t),s+e.length+t).trim()+(s+e.length<i.length?"...":"")}class j extends O.BaseAdapter{constructor(e,t,s){super(e,t,s);const o=g.readConfObject(e,"ixFilePath"),r=g.readConfObject(e,"ixxFilePath");if(!o)throw new Error("must provide out.ix");if(!r)throw new Error("must provide out.ixx");this.trixJs=new v(I.openLocation(r,s),I.openLocation(o,s),1500)}async searchIndex(e){const t=e.queryString.toLowerCase(),s=t.split(" "),r=(await this.trixJs.search(t)).filter(([,n])=>s.every(l=>b(n).toLowerCase().includes(l))).map(([n,l])=>{const c=JSON.parse(l.replaceAll("|",",")),[d,h,...f]=c.map(a=>b(a)),y=f.findIndex(a=>!!a),F=f.map(a=>a.toLowerCase()).findIndex(a=>a.includes(n.toLowerCase())),w=f[y],C=f[F],p=F!==-1?L(C,n):void 0,u=L(w,n),m=!p||u.toLowerCase()===p.toLowerCase()?u:`${u} (${p})`;return new E({locString:d,label:w,displayString:m,matchedObject:c.map(a=>decodeURIComponent(a)),trackId:h})});return e.searchType==="exact"?r.filter(n=>n.getLabel().toLowerCase()===e.queryString.toLowerCase()):r}}export{j as default};
//# sourceMappingURL=TrixTextSearchAdapter-CgY3s9MW.js.map
