{"version":3,"file":"makeImageData-CHa5wZdL.js","sources":["../node_modules/@jbrowse/plugin-variants/esm/MultiLinearVariantRenderer/makeImageData.js"],"sourcesContent":["import { featureSpanPx, forEachWithStopTokenCheck, updateStatus, } from '@jbrowse/core/util';\nimport Flatbush from '@jbrowse/core/util/flatbush';\nimport { checkStopToken } from '@jbrowse/core/util/stopToken';\nimport { f2 } from '../shared/constants';\nimport { drawColorAlleleCount, getColorAlleleCount, } from '../shared/drawAlleleCount';\nimport { drawPhased } from '../shared/drawPhased';\nimport { getFeaturesThatPassMinorAlleleFrequencyFilter } from '../shared/minorAlleleFrequencyUtils';\nexport async function makeImageData(ctx, props) {\n    const { scrollTop, minorAlleleFrequencyFilter, sources, rowHeight, features, regions, bpPerPx, renderingMode, stopToken, lengthCutoffFilter, referenceDrawingMode, } = props;\n    const region = regions[0];\n    const { statusCallback = () => { } } = props;\n    checkStopToken(stopToken);\n    const mafs = await updateStatus('Calculating stats', statusCallback, () => getFeaturesThatPassMinorAlleleFrequencyFilter({\n        stopToken,\n        features: features.values(),\n        minorAlleleFrequencyFilter,\n        lengthCutoffFilter,\n    }));\n    checkStopToken(stopToken);\n    const coords = [];\n    const items = [];\n    const colorCache = {};\n    await updateStatus('Drawing variants', statusCallback, () => {\n        forEachWithStopTokenCheck(mafs, stopToken, ({ mostFrequentAlt, feature }) => {\n            const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx);\n            const featureId = feature.id();\n            const bpLen = feature.get('end') - feature.get('start');\n            const w = Math.max(Math.round(rightPx - leftPx), 2);\n            const samp = feature.get('genotypes');\n            let y = -scrollTop;\n            const s = sources.length;\n            if (renderingMode === 'phased') {\n                for (let j = 0; j < s; j++) {\n                    const { name, HP } = sources[j];\n                    const genotype = samp[name];\n                    const x = Math.floor(leftPx);\n                    const h = Math.max(rowHeight, 1);\n                    if (genotype) {\n                        const isPhased = genotype.includes('|');\n                        if (isPhased) {\n                            const alleles = genotype.split('|');\n                            if (drawPhased(alleles, ctx, x, y, w, h, HP, undefined, referenceDrawingMode === 'draw')) {\n                                items.push({\n                                    name,\n                                    genotype,\n                                    featureId,\n                                    bpLen,\n                                });\n                                coords.push(x, y, x + w, y + h);\n                            }\n                        }\n                        else {\n                            ctx.fillStyle = 'black';\n                            ctx.fillRect(x - f2, y - f2, w + f2, h + f2);\n                        }\n                    }\n                    y += rowHeight;\n                }\n            }\n            else {\n                for (let j = 0; j < s; j++) {\n                    const { name } = sources[j];\n                    const genotype = samp[name];\n                    const x = Math.floor(leftPx);\n                    const h = Math.max(rowHeight, 1);\n                    if (genotype) {\n                        const cacheKey = `${genotype}:${mostFrequentAlt}`;\n                        let c = colorCache[cacheKey];\n                        if (c === undefined) {\n                            let alt = 0;\n                            let uncalled = 0;\n                            let alt2 = 0;\n                            let ref = 0;\n                            const alleles = genotype.split(/[/|]/);\n                            const total = alleles.length;\n                            for (let i = 0; i < total; i++) {\n                                const allele = alleles[i];\n                                if (allele === mostFrequentAlt) {\n                                    alt++;\n                                }\n                                else if (allele === '0') {\n                                    ref++;\n                                }\n                                else if (allele === '.') {\n                                    uncalled++;\n                                }\n                                else {\n                                    alt2++;\n                                }\n                            }\n                            c = getColorAlleleCount(ref, alt, alt2, uncalled, total, referenceDrawingMode === 'draw');\n                            colorCache[cacheKey] = c;\n                        }\n                        if (c) {\n                            drawColorAlleleCount(c, ctx, x, y, w, h, feature.get('type'), feature.get('strand'), bpLen > 5 ? 0.75 : 1);\n                            items.push({\n                                name,\n                                genotype,\n                                featureId,\n                                bpLen,\n                            });\n                            coords.push(x, y, x + w, y + h);\n                        }\n                    }\n                    y += rowHeight;\n                }\n            }\n        });\n    });\n    const flatbush = new Flatbush(Math.max(items.length, 1));\n    if (items.length) {\n        for (let i = 0; i < coords.length; i += 4) {\n            flatbush.add(coords[i], coords[i + 1], coords[i + 2], coords[i + 3]);\n        }\n    }\n    else {\n        flatbush.add(0, 0);\n    }\n    flatbush.finish();\n    return {\n        flatbush: flatbush.data,\n        items,\n        featureGenotypeMap: Object.fromEntries(mafs.map(({ feature }) => [\n            feature.id(),\n            {\n                alt: feature.get('ALT'),\n                ref: feature.get('REF'),\n                name: feature.get('name'),\n                description: feature.get('description'),\n                length: feature.get('end') - feature.get('start'),\n            },\n        ])),\n    };\n}\n"],"names":["makeImageData","ctx","props","scrollTop","minorAlleleFrequencyFilter","sources","rowHeight","features","regions","bpPerPx","renderingMode","stopToken","lengthCutoffFilter","referenceDrawingMode","region","statusCallback","checkStopToken","mafs","updateStatus","getFeaturesThatPassMinorAlleleFrequencyFilter","coords","items","colorCache","forEachWithStopTokenCheck","mostFrequentAlt","feature","leftPx","rightPx","featureSpanPx","featureId","bpLen","w","samp","y","s","j","name","HP","genotype","x","h","alleles","drawPhased","f2","cacheKey","c","alt","uncalled","alt2","ref","total","i","allele","getColorAlleleCount","drawColorAlleleCount","flatbush","Flatbush"],"mappings":"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","x_google_ignoreList":[0]}