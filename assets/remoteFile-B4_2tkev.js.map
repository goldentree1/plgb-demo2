{"version":3,"file":"remoteFile-B4_2tkev.js","sources":["../../node_modules/generic-filehandle2/esm/remoteFile.js"],"sourcesContent":["function getMessage(e) {\n    const r = typeof e === 'object' && e !== null && 'message' in e\n        ? e.message\n        : `${e}`;\n    return r.replace(/\\.$/, '');\n}\nexport default class RemoteFile {\n    constructor(source, opts = {}) {\n        this.baseOverrides = {};\n        this.url = source;\n        const fetch = opts.fetch || globalThis.fetch.bind(globalThis);\n        if (opts.overrides) {\n            this.baseOverrides = opts.overrides;\n        }\n        this.fetchImplementation = fetch;\n    }\n    async fetch(input, init) {\n        const wrapError = (e) => new Error(`${getMessage(e)} fetching ${input}`, { cause: e });\n        let response;\n        try {\n            response = await this.fetchImplementation(input, init);\n        }\n        catch (e) {\n            if (`${e}`.includes('Failed to fetch')) {\n                // refetch to help work around a chrome bug (discussed in\n                // generic-filehandle issue #72) in which the chrome cache returns a\n                // CORS error for content in its cache.  see also\n                // https://github.com/GMOD/jbrowse-components/pull/1511\n                console.warn(`generic-filehandle: refetching ${input} to attempt to work around chrome CORS header caching bug`);\n                try {\n                    response = await this.fetchImplementation(input, {\n                        ...init,\n                        cache: 'reload',\n                    });\n                }\n                catch (e) {\n                    throw wrapError(e);\n                }\n            }\n            else {\n                throw wrapError(e);\n            }\n        }\n        return response;\n    }\n    async read(length, position, opts = {}) {\n        if (length === 0) {\n            return new Uint8Array(0);\n        }\n        const { headers = {}, signal, overrides = {} } = opts;\n        if (length < Infinity) {\n            headers.range = `bytes=${position}-${position + length - 1}`;\n        }\n        else if (length === Infinity && position !== 0) {\n            headers.range = `bytes=${position}-`;\n        }\n        const res = await this.fetch(this.url, {\n            ...this.baseOverrides,\n            ...overrides,\n            headers: {\n                ...this.baseOverrides.headers,\n                ...overrides.headers,\n                ...headers,\n            },\n            method: 'GET',\n            redirect: 'follow',\n            mode: 'cors',\n            signal,\n        });\n        if (!res.ok) {\n            throw new Error(`HTTP ${res.status} fetching ${this.url}`);\n        }\n        if ((res.status === 200 && position === 0) || res.status === 206) {\n            // try to parse out the size of the remote file\n            const contentRange = res.headers.get('content-range');\n            const sizeMatch = /\\/(\\d+)$/.exec(contentRange || '');\n            if (sizeMatch?.[1]) {\n                this._stat = {\n                    size: parseInt(sizeMatch[1], 10),\n                };\n            }\n            // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n            const resData = res.bytes\n                ? await res.bytes()\n                : new Uint8Array(await res.arrayBuffer());\n            return resData.byteLength <= length\n                ? resData\n                : resData.subarray(0, length);\n        }\n        throw new Error(res.status === 200\n            ? `${this.url} fetch returned status 200, expected 206`\n            : `HTTP ${res.status} fetching ${this.url}`);\n    }\n    async readFile(options = {}) {\n        let encoding;\n        let opts;\n        if (typeof options === 'string') {\n            encoding = options;\n            opts = {};\n        }\n        else {\n            encoding = options.encoding;\n            const { encoding: _, ...rest } = options;\n            opts = rest;\n        }\n        const { headers = {}, signal, overrides = {} } = opts;\n        const res = await this.fetch(this.url, {\n            ...this.baseOverrides,\n            ...overrides,\n            headers: {\n                ...this.baseOverrides.headers,\n                ...overrides.headers,\n                ...headers,\n            },\n            method: 'GET',\n            redirect: 'follow',\n            mode: 'cors',\n            signal,\n        });\n        if (!res.ok) {\n            throw new Error(`HTTP ${res.status} fetching ${this.url}`);\n        }\n        if (encoding === 'utf8') {\n            return res.text();\n        }\n        else if (encoding) {\n            throw new Error(`unsupported encoding: ${encoding}`);\n        }\n        else {\n            // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n            return res.bytes ? res.bytes() : new Uint8Array(await res.arrayBuffer());\n        }\n    }\n    async stat() {\n        if (!this._stat) {\n            await this.read(10, 0);\n            // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n            if (!this._stat) {\n                throw new Error(`unable to determine size of file at ${this.url}`);\n            }\n        }\n        return this._stat;\n    }\n    async close() {\n        return;\n    }\n}\n//# sourceMappingURL=remoteFile.js.map"],"names":["getMessage","e","RemoteFile","source","opts","fetch","input","init","wrapError","response","length","position","headers","signal","overrides","res","contentRange","sizeMatch","resData","options","encoding","_","rest"],"mappings":"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","x_google_ignoreList":[0]}